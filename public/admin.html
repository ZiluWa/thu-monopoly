<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç®¡ç†çœ‹æ¿ - æ¸…åå¤§å¯Œç¿</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, 'Segoe UI', sans-serif; background:#f0f2f5; color:#333; min-height:100vh; }
.login { display:flex; align-items:center; justify-content:center; min-height:100vh; }
.login-box { background:#fff; padding:40px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.1); text-align:center; }
.login-box h2 { margin-bottom:20px; }
.login-box input { padding:10px 16px; border:1px solid #d9d9d9; border-radius:6px; font-size:16px; width:220px; }
.login-box button { margin-left:8px; padding:10px 20px; background:#1677ff; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer; }
.login-box button:hover { background:#4096ff; }
.login-box .err { color:#e74c3c; margin-top:12px; font-size:14px; }

.dashboard { display:none; max-width:1100px; margin:0 auto; padding:24px 16px; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
header h1 { font-size:22px; }
header .meta { font-size:13px; color:#888; }
.cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-bottom:24px; }
.card { background:#fff; border-radius:10px; padding:20px; box-shadow:0 1px 4px rgba(0,0,0,.08); }
.card .label { font-size:13px; color:#888; margin-bottom:4px; }
.card .value { font-size:28px; font-weight:700; }
.card .value.blue { color:#1677ff; }
.card .value.green { color:#52c41a; }
.card .value.orange { color:#fa8c16; }
.card .value.purple { color:#722ed1; }

h3 { font-size:16px; margin-bottom:12px; }
table { width:100%; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,.08); border-collapse:collapse; margin-bottom:24px; }
th, td { text-align:left; padding:10px 14px; border-bottom:1px solid #f0f0f0; font-size:13px; }
th { background:#fafafa; font-weight:600; color:#666; }
.badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:12px; }
.badge.waiting { background:#fff7e6; color:#d46b08; }
.badge.playing { background:#f6ffed; color:#389e0d; }
.badge.finished { background:#f0f5ff; color:#1d39c4; }
.badge.abandoned { background:#fff1f0; color:#cf1322; }
.empty { text-align:center; color:#bbb; padding:24px; }

.history-section { margin-bottom:24px; }
.game-detail { background:#fafafa; border-radius:6px; padding:8px 12px; margin-top:6px; }
.game-detail .player-row { display:flex; align-items:center; gap:8px; padding:3px 0; font-size:12px; border-bottom:1px solid #eee; }
.game-detail .player-row:last-child { border:none; }
.player-row .p-name { font-weight:600; min-width:60px; }
.player-row .p-money { color:#27ae60; font-weight:600; }
.player-row .p-money.bankrupt { color:#e74c3c; }
.player-row .p-props { color:#888; }
.expand-btn { background:none; border:none; color:#1677ff; cursor:pointer; font-size:12px; padding:0; }
.expand-btn:hover { text-decoration:underline; }
</style>
</head>
<body>

<div class="login" id="loginView">
  <div class="login-box">
    <h2>ç®¡ç†çœ‹æ¿</h2>
    <div>
      <input type="password" id="pwInput" placeholder="è¾“å…¥ç®¡ç†å¯†ç " onkeydown="if(event.key==='Enter')doLogin()">
      <button onclick="doLogin()">è¿›å…¥</button>
    </div>
    <div class="err" id="loginErr"></div>
  </div>
</div>

<div class="dashboard" id="dashView">
  <header>
    <h1>æ¸…åå¤§å¯Œç¿ ç®¡ç†çœ‹æ¿</h1>
    <div class="meta">
      <span id="uptime"></span> | æ¯5ç§’åˆ·æ–° | <a href="#" onclick="doLogout();return false">é€€å‡º</a>
    </div>
  </header>

  <div class="cards">
    <div class="card"><div class="label">å½“å‰åœ¨çº¿</div><div class="value blue" id="cOnline">-</div></div>
    <div class="card"><div class="label">åœ¨æˆ¿é—´ä¸­</div><div class="value green" id="cInRoom">-</div></div>
    <div class="card"><div class="label">é—²é€›ä¸­</div><div class="value orange" id="cIdle">-</div></div>
    <div class="card"><div class="label">æ´»è·ƒæˆ¿é—´</div><div class="value green" id="cRooms">-</div></div>
    <div class="card"><div class="label">æœ€è¿‘1å°æ—¶è¿æ¥</div><div class="value blue" id="cConnHour">-</div></div>
  </div>

  <h3>æ•°æ®ç»Ÿè®¡</h3>
  <table>
    <thead><tr><th></th><th>ä»Šæ—¥</th><th>æœ¬å‘¨</th><th>æœ¬æœˆ</th><th>ç´¯è®¡</th></tr></thead>
    <tbody>
      <tr><td><b>é¡µé¢è®¿é—®</b> <span style="color:#999;font-size:11px">æ¬¡</span></td><td id="fVisitD">-</td><td id="fVisitW">-</td><td id="fVisitM">-</td><td id="fVisitT">-</td></tr>
      <tr><td><b>è¿›å…¥æˆ¿é—´</b> <span style="color:#999;font-size:11px">äººæ¬¡</span></td><td id="fRoomD">-</td><td id="fRoomW">-</td><td id="fRoomM">-</td><td id="fRoomT">-</td></tr>
      <tr><td><b>å¼€å§‹æ¸¸æˆ</b> <span style="color:#999;font-size:11px">å±€</span></td><td id="fGameD">-</td><td id="fGameW">-</td><td id="fGameM">-</td><td id="fGameT">-</td></tr>
      <tr><td><b>å‚ä¸æ¸¸æˆ</b> <span style="color:#999;font-size:11px">äººæ¬¡</span></td><td id="fPlayerD">-</td><td id="fPlayerW">-</td><td id="fPlayerM">-</td><td id="fPlayerT">-</td></tr>
      <tr><td><b>å‚ä¸æ¸¸æˆ</b> <span style="color:#999;font-size:11px">å»é‡</span></td><td id="fUPlayerD">-</td><td id="fUPlayerW">-</td><td id="fUPlayerM">-</td><td id="fUPlayerT">-</td></tr>
    </tbody>
  </table>

  <h3>å½“å‰æˆ¿é—´</h3>
  <table>
    <thead><tr><th>æˆ¿é—´ä»£ç </th><th>ç©å®¶</th><th>çŠ¶æ€</th><th>å›åˆ</th></tr></thead>
    <tbody id="roomBody"><tr><td colspan="4" class="empty">æ— æ´»è·ƒæˆ¿é—´</td></tr></tbody>
  </table>

  <div class="history-section">
    <h3>æœ€è¿‘è®°å½•</h3>
    <table>
      <thead><tr><th>æ—¶é—´</th><th>æˆ¿é—´</th><th>ç©å®¶</th><th>çŠ¶æ€</th><th>å›åˆ</th><th>æ—¶é•¿</th><th>è¯¦æƒ…</th></tr></thead>
      <tbody id="histBody"><tr><td colspan="7" class="empty">æš‚æ— è®°å½•</td></tr></tbody>
    </table>
  </div>
</div>

<script>
let pw = sessionStorage.getItem('admin_pw') || '';
let timer = null;

if (pw) { showDashboard(); }

function doLogin() {
  pw = document.getElementById('pwInput').value;
  document.getElementById('loginErr').textContent = '';
  fetch('/api/stats?pw=' + encodeURIComponent(pw))
    .then(r => { if (!r.ok) throw new Error(); return r.json(); })
    .then(() => { sessionStorage.setItem('admin_pw', pw); showDashboard(); })
    .catch(() => { document.getElementById('loginErr').textContent = 'å¯†ç é”™è¯¯'; });
}

function doLogout() {
  pw = '';
  sessionStorage.removeItem('admin_pw');
  clearInterval(timer);
  document.getElementById('dashView').style.display = 'none';
  document.getElementById('loginView').style.display = 'flex';
  document.getElementById('pwInput').value = '';
}

function showDashboard() {
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('dashView').style.display = 'block';
  refresh();
  timer = setInterval(refresh, 5000);
}

function fmtDuration(ms) {
  if (!ms) return '-';
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
  if (h > 0) return h + 'æ—¶' + m + 'åˆ†';
  if (m > 0) return m + 'åˆ†' + (s%60) + 'ç§’';
  return s + 'ç§’';
}

function fmtUptime(ms) {
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400), h = Math.floor((s%86400)/3600), m = Math.floor((s%3600)/60);
  let r = '';
  if (d) r += d + 'å¤©';
  if (h) r += h + 'å°æ—¶';
  r += m + 'åˆ†é’Ÿ';
  return 'è¿è¡Œ ' + r;
}

function toggleDetail(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function refresh() {
  fetch('/api/stats?pw=' + encodeURIComponent(pw))
    .then(r => { if (!r.ok) { doLogout(); throw new Error(); } return r.json(); })
    .then(d => {
      document.getElementById('cOnline').textContent = d.online;
      document.getElementById('cInRoom').textContent = d.inRoom;
      document.getElementById('cIdle').textContent = d.idle;
      document.getElementById('cRooms').textContent = d.activeRooms;
      document.getElementById('cConnHour').textContent = d.connLastHour;
      document.getElementById('uptime').textContent = fmtUptime(d.uptimeMs);
      // Funnel
      document.getElementById('fVisitD').textContent = d.visitDay;
      document.getElementById('fVisitW').textContent = d.visitWeek;
      document.getElementById('fVisitM').textContent = d.visitMonth;
      document.getElementById('fVisitT').textContent = d.totalConnections;
      document.getElementById('fRoomD').textContent = d.roomDay;
      document.getElementById('fRoomW').textContent = d.roomWeek;
      document.getElementById('fRoomM').textContent = d.roomMonth;
      document.getElementById('fRoomT').textContent = d.totalRooms;
      document.getElementById('fGameD').textContent = d.gameDay;
      document.getElementById('fGameW').textContent = d.gameWeek;
      document.getElementById('fGameM').textContent = d.gameMonth;
      document.getElementById('fGameT').textContent = d.totalGames;
      document.getElementById('fPlayerD').textContent = d.playerDay;
      document.getElementById('fPlayerW').textContent = d.playerWeek;
      document.getElementById('fPlayerM').textContent = d.playerMonth;
      document.getElementById('fPlayerT').textContent = d.playerTotal;
      document.getElementById('fUPlayerD').textContent = d.uniquePlayerDay;
      document.getElementById('fUPlayerW').textContent = d.uniquePlayerWeek;
      document.getElementById('fUPlayerM').textContent = d.uniquePlayerMonth;
      document.getElementById('fUPlayerT').textContent = d.uniquePlayerTotal;

      const rb = document.getElementById('roomBody');
      if (d.roomList.length === 0) {
        rb.innerHTML = '<tr><td colspan="4" class="empty">æ— æ´»è·ƒæˆ¿é—´</td></tr>';
      } else {
        rb.innerHTML = d.roomList.map(r => {
          const names = r.players.map(p => (p.roleEmoji||'ğŸ’') + p.name + '(' + (p.roleName||'æ–°ç”Ÿ') + ')' + (p.disconnected ? '<span style="color:#e74c3c">(ç¦»çº¿)</span>' : '')).join(', ');
          const status = r.started
            ? '<span class="badge playing">æ¸¸æˆä¸­</span>'
            : '<span class="badge waiting">ç­‰å¾…ä¸­</span>';
          return `<tr><td><b>${r.code}</b></td><td>${names}</td><td>${status}</td><td>${r.round}</td></tr>`;
        }).join('');
      }

      // Merged history: combine roomHistory + gameHistory
      const gameMap = {};
      (d.gameHistory || []).forEach(g => { gameMap[g.code] = g; });

      // Build combined entries from roomHistory
      const combined = [];
      const usedGameCodes = new Set();
      (d.roomHistory || []).forEach(r => {
        const g = gameMap[r.code];
        if (g) usedGameCodes.add(r.code);
        const roleData = g && g.playerRoles;
        const nameStr = roleData
          ? roleData.map(pr => (pr.roleEmoji||'') + pr.name + '(' + (pr.roleName||'æ–°ç”Ÿ') + ')').join(', ')
          : (r.playerNames || []).join(', ');
        combined.push({
          time: r.createTime,
          code: r.code,
          names: nameStr,
          gameStarted: r.gameStarted,
          game: g || null,
        });
      });
      // Add old gameHistory entries not in roomHistory
      (d.gameHistory || []).forEach(g => {
        if (!usedGameCodes.has(g.code)) {
          const roleData = g.playerRoles;
          const nameStr = roleData
            ? roleData.map(pr => (pr.roleEmoji||'') + pr.name + '(' + (pr.roleName||'æ–°ç”Ÿ') + ')').join(', ')
            : (g.playerNames || (g.players && g.players.map ? g.players.map(p=>p.name) : g.players) || []).join(', ');
          combined.push({
            time: g.startTime || g.time,
            code: g.code,
            names: nameStr,
            gameStarted: true,
            game: g,
          });
        }
      });
      // Sort by time descending
      combined.sort((a, b) => new Date(b.time) - new Date(a.time));

      const hb = document.getElementById('histBody');
      if (combined.length === 0) {
        hb.innerHTML = '<tr><td colspan="7" class="empty">æš‚æ— è®°å½•</td></tr>';
      } else {
        hb.innerHTML = combined.map(c => {
          const t = new Date(c.time).toLocaleString('zh-CN');
          const g = c.game;

          let status, rounds = '-', dur = '-', detailHtml = '';
          if (!c.gameStarted) {
            status = '<span class="badge waiting">æœªå¼€å§‹</span>';
          } else if (g && g._active) {
            status = '<span class="badge playing">è¿›è¡Œä¸­</span>';
            rounds = g.rounds || '-';
          } else if (g && g.finished) {
            status = '<span class="badge finished">å·²ç»“æŸ' + (g.winner ? ' - ' + g.winner + 'èƒœ' : '') + '</span>';
            rounds = g.rounds || '-';
            dur = fmtDuration(g.durationMs);
          } else {
            status = '<span class="badge abandoned">å·²æ”¾å¼ƒ</span>';
            if (g) { rounds = g.rounds || '-'; dur = fmtDuration(g.durationMs); }
          }

          // Player detail (from finalized game data)
          if (g && g.players && g.players.length && typeof g.players[0] === 'object') {
            const rows = g.players.map(p => {
              const moneyClass = p.bankrupt ? 'p-money bankrupt' : 'p-money';
              const moneyText = p.bankrupt ? 'ç ´äº§' : 'Â¥' + p.money.toLocaleString();
              const props = p.propertyNames && p.propertyNames.length > 0
                ? p.propertyNames.join('ã€')
                : 'æ— åœ°äº§';
              const roleTag = (p.roleEmoji||'') + (p.roleName||'');
              return `<div class="player-row"><span class="p-name">${roleTag ? roleTag+' ' : ''}${p.name}</span><span class="${moneyClass}">${moneyText}</span><span class="p-props">${p.properties}å—: ${props}</span></div>`;
            }).join('');
            detailHtml = `<div class="game-detail">${rows}</div>`;
          }

          return `<tr><td>${t}</td><td><b>${c.code}</b></td><td>${c.names}</td><td>${status}</td><td>${rounds}</td><td>${dur}</td><td>${detailHtml}</td></tr>`;
        }).join('');
      }
    })
    .catch(() => {});
}
</script>
</body>
</html>
