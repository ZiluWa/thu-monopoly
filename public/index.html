<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¸…åå¤§å¯Œç¿ - åœ¨çº¿ç‰ˆ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--purple:#660874;--light:#f3e8f9;--bg:#f5f0eb}
    body{font-family:-apple-system,'PingFang SC','Microsoft YaHei',sans-serif;background:var(--bg);color:#333;overflow-x:hidden}
    button{cursor:pointer;font-family:inherit}

    /* ===== LOBBY ===== */
    .lobby{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:16px}
    .lobby-box{width:100%;max-width:380px;text-align:center}
    .lobby-icon{font-size:52px;margin-bottom:4px}
    .lobby-box h1{font-size:28px;color:var(--purple);letter-spacing:3px}
    .lobby-box .sub{color:#999;font-size:13px;margin-bottom:24px}
    .lcard{background:#fff;border-radius:14px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:12px;text-align:left}
    .lcard h3{color:var(--purple);font-size:15px;margin-bottom:12px}
    .lcard input{width:100%;padding:12px 14px;border:2px solid #e8e8e8;border-radius:10px;font-size:15px;margin-bottom:8px;font-family:inherit;outline:none;transition:border .2s}
    .lcard input:focus{border-color:var(--purple)}
    .lcard input.code-input{text-transform:uppercase;font-weight:700;letter-spacing:6px;text-align:center;font-size:18px}
    .lbtn{width:100%;padding:14px;border:none;border-radius:10px;font-size:15px;font-weight:600;color:#fff;background:var(--purple)}
    .lbtn:active{opacity:.85}
    .lbtn.sec{background:#ece4f0;color:var(--purple)}
    .footer-info{margin-top:24px;font-size:11px;color:#bbb;line-height:1.6}

    /* ===== ROOM ===== */
    .room-view{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:16px}
    .room-box{width:100%;max-width:400px;text-align:center}
    .room-box h2{color:var(--purple);font-size:20px;margin-bottom:16px}
    .code-card{background:#fff;border-radius:14px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:14px}
    .code-label{font-size:12px;color:#999;margin-bottom:8px}
    .code-chars{display:flex;justify-content:center;gap:5px;margin-bottom:10px}
    .code-char{width:40px;height:48px;background:var(--light);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;color:var(--purple)}
    .code-copy{background:none;border:1px solid #ddd;padding:6px 14px;border-radius:8px;font-size:12px;color:#888}
    .plist{background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:14px;text-align:left}
    .plist h4{color:var(--purple);font-size:14px;margin-bottom:10px}
    .pl-item{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid #f0f0f0}
    .pl-item:last-child{border:none}
    .pl-dot{width:22px;height:22px;border-radius:50%;flex-shrink:0}
    .pl-name{flex:1;font-weight:600;font-size:14px}
    .pl-badge{font-size:10px;background:var(--light);color:var(--purple);padding:2px 8px;border-radius:8px}
    .pl-wait{color:#ccc;font-size:12px;padding:10px 0;text-align:center}
    .room-btns{display:flex;gap:8px}
    .room-btns button{flex:1;padding:14px;border:none;border-radius:10px;font-size:14px;font-weight:600}
    .btn-go{background:var(--purple);color:#fff}
    .btn-out{background:#eee;color:#888}

    /* ===== GAME: TOP BAR ===== */
    .topbar{position:sticky;top:0;z-index:100;background:var(--purple);color:#fff;display:flex;align-items:center;padding:0 12px;height:46px;gap:8px}
    .topbar .title{font-size:15px;font-weight:700;white-space:nowrap}
    .topbar .room-tag{font-size:11px;background:rgba(255,255,255,.2);padding:3px 8px;border-radius:5px;letter-spacing:1px}
    .topbar .spacer{flex:1}
    .topbar .menu-btn{background:none;border:none;color:#fff;font-size:20px;padding:6px}
    .dropdown{position:absolute;top:46px;right:0;background:#fff;border-radius:0 0 12px 12px;box-shadow:0 8px 24px rgba(0,0,0,.15);min-width:180px;z-index:101;overflow:hidden}
    .dropdown button{display:block;width:100%;padding:14px 18px;border:none;background:none;text-align:left;font-size:14px;border-bottom:1px solid #f0f0f0}
    .dropdown button:active{background:#f5f5f5}
    .dropdown button:last-child{border:none}

    /* ===== GAME: BOARD ===== */
    .board-wrap{padding:8px;display:flex;justify-content:center;overflow:hidden}
    .board{
      width:100%;max-width:722px;aspect-ratio:1;
      display:grid;
      grid-template-columns:100fr repeat(9,58fr) 100fr;
      grid-template-rows:100fr repeat(9,58fr) 100fr;
      border:2px solid #444;background:#cde6d0;
    }
    .board-center{grid-column:2/11;grid-row:2/11;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:8px;position:relative;overflow:hidden}
    .board-center .bc-bg{display:flex;flex-direction:column;align-items:center;justify-content:center}
    .board-center .gate{font-size:clamp(20px,5vw,40px)}
    .board-center h2{font-size:clamp(12px,3.5vw,24px);color:var(--purple);letter-spacing:4px}
    .board-center .motto{font-size:clamp(7px,2vw,12px);color:#555;letter-spacing:3px;margin-top:2px}
    .board-center .bc-turn{font-size:clamp(9px,2.5vw,14px);color:var(--purple);font-weight:700;margin-top:clamp(4px,1.5vw,10px)}
    .board-center .btn-roll{margin-top:clamp(4px,1.5vw,10px);background:#e74c3c;color:#fff;border:none;padding:clamp(6px,2vw,14px) clamp(16px,5vw,40px);border-radius:10px;font-size:clamp(10px,3vw,18px);font-weight:700;cursor:pointer}
    .board-center .btn-roll:active{background:#c0392b}
    .board-center .btn-roll:disabled{background:#ccc;cursor:default}
    .dice-popup{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:5;animation:popIn .3s ease}
    @keyframes popIn{0%{opacity:0;transform:scale(.6)}100%{opacity:1;transform:scale(1)}}
    .dice-popup .dp-dice{display:flex;gap:clamp(6px,2vw,16px);margin-bottom:clamp(4px,1.5vw,10px)}
    .dice-popup .dp-die{width:clamp(32px,10vw,64px);height:clamp(32px,10vw,64px);background:#fff;border:3px solid #333;border-radius:clamp(6px,1.5vw,12px);display:flex;align-items:center;justify-content:center;font-size:clamp(20px,6vw,40px);font-weight:700}
    .dice-popup .dp-die.rolling{animation:shake .12s infinite alternate}
    .dice-popup .dp-total{font-size:clamp(12px,3.5vw,22px);font-weight:800;color:var(--purple)}
    .dice-popup .dp-double{font-size:clamp(10px,2.5vw,16px);color:#e74c3c;font-weight:700}
    .move-info{position:absolute;bottom:clamp(4px,1.5vw,12px);left:0;right:0;text-align:center;z-index:6;pointer-events:none}
    .move-info .mi-label{display:inline-block;background:var(--purple);color:#fff;padding:clamp(3px,1vw,8px) clamp(8px,2.5vw,18px);border-radius:20px;font-size:clamp(9px,2.5vw,16px);font-weight:600;animation:popIn .2s ease}
    .cell{border:1px solid #555;position:relative;overflow:hidden;background:#e8f5e9;display:flex;flex-direction:column}
    .cell .color-bar{flex-shrink:0}
    .cell.side-bottom .color-bar{height:clamp(6px,2vw,14px);width:100%}
    .cell.side-bottom .cell-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px}
    .cell.side-top{flex-direction:column-reverse}
    .cell.side-top .color-bar{height:clamp(6px,2vw,14px);width:100%}
    .cell.side-top .cell-body{flex:1;display:flex;flex-direction:column-reverse;align-items:center;justify-content:center;gap:1px}
    .cell.side-left{flex-direction:row-reverse}
    .cell.side-left .color-bar{width:clamp(6px,2vw,14px);height:100%}
    .cell.side-left .cell-body{flex:1;display:flex;flex-direction:column-reverse;align-items:center;justify-content:center;writing-mode:vertical-rl;text-orientation:mixed;gap:1px}
    .cell.side-right{flex-direction:row}
    .cell.side-right .color-bar{width:clamp(6px,2vw,14px);height:100%}
    .cell.side-right .cell-body{flex:1;display:flex;flex-direction:column-reverse;align-items:center;justify-content:center;writing-mode:vertical-rl;text-orientation:mixed;gap:1px}
    .cell .cell-icon{font-size:clamp(8px,2.2vw,16px);line-height:1}
    .cell .cell-name{font-size:clamp(5px,1.4vw,10px);font-weight:600;line-height:1.1;text-align:center}
    .cell .cell-price{font-size:clamp(4px,1.1vw,8px);color:#555}
    .cell.corner{display:flex;flex-direction:column;align-items:center;justify-content:center;background:#d4edda;text-align:center}
    .cell.corner .cell-icon{font-size:clamp(12px,3.5vw,24px)}
    .cell.corner .cell-name{font-size:clamp(6px,1.6vw,11px);font-weight:700}
    .cell.type-go{background:#d4edda}.cell.type-jail{background:#f0e0d0}.cell.type-parking{background:#ffe0e8}
    .cell.type-gotojail{background:#ffd0d0}.cell.type-tax{background:#f5f5dc}.cell.type-chance{background:#fff3cd}
    .cell.type-chest{background:#d1ecf1}.cell.type-railroad{background:#e2e3e5}.cell.type-utility{background:#e2e3e5}
    .cell .tokens{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;gap:0;flex-wrap:wrap;z-index:2;line-height:1;pointer-events:none}
    .cell .tokens .tk{font-size:clamp(14px,5vw,40px)}

    /* ===== GAME: CONTROLS ===== */
    .controls{max-width:640px;margin:0 auto;padding:8px 12px 20px}
    @keyframes shake{0%{transform:rotate(-8deg) scale(1.05)}100%{transform:rotate(8deg) scale(1.05)}}

    .player-card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 1px 6px rgba(0,0,0,.05);margin-bottom:8px;border-left:5px solid #ccc}
    .player-card.is-me{box-shadow:0 0 0 2px var(--purple)}
    .player-card.on-turn{background:#fffbe6}
    .pc-top{display:flex;justify-content:space-between;align-items:center}
    .pc-name{font-weight:700;font-size:14px}
    .pc-money{font-size:18px;font-weight:800;color:#27ae60}
    .pc-money.negative{color:#e74c3c}
    .pc-pos{font-size:11px;color:#999;margin:4px 0}
    .pc-props{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px}
    .pc-dot{width:14px;height:9px;border-radius:2px;border:1px solid rgba(0,0,0,.15)}
    .pc-emoji{font-size:16px;margin-right:4px}

    .log-box{background:#fff;border-radius:12px;padding:12px;box-shadow:0 1px 6px rgba(0,0,0,.05);margin-bottom:10px;max-height:160px;overflow-y:auto}
    .log-box h4{font-size:13px;color:var(--purple);margin-bottom:6px}
    .log-entry{font-size:11px;padding:3px 0;border-bottom:1px solid #f7f7f7;color:#666}

    .game-footer{text-align:center;padding:20px 12px 30px;font-size:11px;color:#bbb;line-height:1.7}
    .game-footer a{color:var(--purple);text-decoration:none}

    /* ===== CHAT ===== */
    .chat-toggle{position:fixed;bottom:16px;right:16px;width:48px;height:48px;border-radius:50%;background:var(--purple);color:#fff;border:none;font-size:20px;box-shadow:0 4px 14px rgba(0,0,0,.2);z-index:120;display:none}
    .chat-toggle .badge{position:absolute;top:-2px;right:-2px;min-width:18px;height:18px;background:#e74c3c;border-radius:9px;font-size:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;padding:0 4px}
    .chat-panel{position:fixed;bottom:72px;right:12px;width:min(320px,calc(100vw - 24px));max-height:360px;background:#fff;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.15);z-index:120;display:flex;flex-direction:column;overflow:hidden}
    .chat-head{background:var(--purple);color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:14px}
    .chat-head button{background:none;border:none;color:#fff;font-size:18px}
    .chat-msgs{flex:1;overflow-y:auto;padding:10px;max-height:230px}
    .chat-msg{margin-bottom:6px}
    .cm-name{font-size:10px;font-weight:600;margin-bottom:1px}
    .cm-text{font-size:12px;background:#f3f3f3;padding:5px 10px;border-radius:8px;display:inline-block;max-width:85%;word-break:break-all}
    .chat-bar{display:flex;gap:6px;padding:8px;border-top:1px solid #eee}
    .chat-bar input{flex:1;padding:8px 10px;border:2px solid #e8e8e8;border-radius:8px;font-size:13px;font-family:inherit;outline:none}
    .chat-bar input:focus{border-color:var(--purple)}
    .chat-bar button{background:var(--purple);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:13px}

    /* ===== OVERLAYS ===== */
    .overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:200;background:var(--bg);overflow-y:auto;display:none}
    .overlay.show{display:block}
    .ov-bar{position:sticky;top:0;background:var(--purple);color:#fff;display:flex;align-items:center;padding:0 14px;height:46px;gap:10px;z-index:1}
    .ov-bar h3{font-size:16px;flex:1}
    .ov-bar button{background:none;border:none;color:#fff;font-size:20px}
    .ov-body{padding:16px;max-width:800px;margin:0 auto}
    .deed-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px}
    .deed-card{border:2px solid #444;border-radius:8px;padding:8px;background:#fff;font-size:10px}
    .deed-card .dc-color{height:16px;border-radius:3px;margin-bottom:4px}
    .deed-card .dc-name{text-align:center;font-size:13px;font-weight:700;margin-bottom:4px}
    .deed-card .dc-sub{text-align:center;font-size:8px;color:#999;margin-bottom:3px}
    .deed-card hr{border:none;border-top:1px solid #ddd;margin:3px 0}
    .deed-card .dc-row{display:flex;justify-content:space-between;padding:1px 0;font-size:10px}
    .event-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:16px}
    .event-card{border:2px solid #444;border-radius:8px;padding:10px;text-align:center;font-size:11px;line-height:1.4}
    .event-card.chance{background:#fff9e6;border-color:#e0a800}
    .event-card.chest{background:#e8f4fd;border-color:#4ab0d5}
    .event-card .ev-title{font-weight:700;font-size:11px;margin-bottom:4px}

    .rules-body{max-width:600px;margin:0 auto;line-height:1.8;font-size:13px}
    .rules-body h3{color:var(--purple);margin:16px 0 4px;border-bottom:2px solid var(--purple);padding-bottom:2px;font-size:15px}
    .rules-body ul{padding-left:18px;margin-bottom:8px}

    /* ===== MODAL ===== */
    .modal-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.45);z-index:300;align-items:center;justify-content:center;padding:16px}
    .modal-bg.show{display:flex}
    .modal{background:#fff;border-radius:14px;padding:22px;width:100%;max-width:380px}
    .modal h3{color:var(--purple);margin-bottom:12px;font-size:16px}
    .modal label{display:block;font-size:11px;color:#888;margin:8px 0 3px}
    .modal select,.modal input{width:100%;padding:10px 12px;border:2px solid #e8e8e8;border-radius:8px;font-size:14px;font-family:inherit;outline:none}
    .modal select:focus,.modal input:focus{border-color:var(--purple)}
    .modal-btns{display:flex;gap:8px;margin-top:16px}
    .modal-btns button{flex:1;padding:12px;border-radius:8px;font-size:14px;border:none;font-weight:600}
    .modal-btns .mc{background:#eee;color:#666}
    .modal-btns .mo{background:var(--purple);color:#fff}

    /* ===== PRINT ===== */
    @media print{
      body>*{display:none!important}
      #view-game{display:block!important}
      .topbar,.controls,.chat-toggle,.chat-panel,.dropdown,.game-footer{display:none!important}
      .board-wrap{padding:0}
      .board{max-width:none;width:260mm;height:260mm;border-width:2px;
        grid-template-columns:36.1mm repeat(9,20.9mm) 36.1mm;
        grid-template-rows:36.1mm repeat(9,20.9mm) 36.1mm}
      .cell .cell-name{font-size:8pt}.cell .cell-price{font-size:7pt}.cell .cell-icon{font-size:11pt}
      .cell.corner .cell-icon{font-size:17pt}.cell.corner .cell-name{font-size:8pt}
      .cell .color-bar{height:4mm!important;width:4mm!important}
      .board-center h2{font-size:30pt}.board-center .gate{font-size:40pt}
      @page{size:A3 landscape;margin:10mm}
    }
  </style>
</head>
<body>

<!-- ==================== LOBBY ==================== -->
<div id="view-lobby" class="lobby">
  <div class="lobby-box">
    <div class="lobby-icon">ğŸ›ï¸</div>
    <h1>æ¸…åå¤§å¯Œç¿</h1>
    <p class="sub">åœ¨çº¿ç‰ˆ Â· å’Œå¥½å‹ä¸€èµ·ç©</p>
    <div class="lcard">
      <h3>åˆ›å»ºæˆ¿é—´</h3>
      <input id="inp-cname" type="text" placeholder="ä½ çš„åå­—" maxlength="10">
      <button class="lbtn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
    </div>
    <div class="lcard">
      <h3>åŠ å…¥æˆ¿é—´</h3>
      <input id="inp-jcode" class="code-input" type="text" placeholder="æˆ¿é—´ä»£ç " maxlength="6">
      <input id="inp-jname" type="text" placeholder="ä½ çš„åå­—" maxlength="10">
      <button class="lbtn sec" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
    </div>
    <div class="footer-info">
      ä½œè€…ï¼šå­è·¯ Â· å¾®ä¿¡ï¼šREBL_unofficial<br>
      <span id="connStatus" style="font-size:10px">è¿æ¥ä¸­...</span>
    </div>
  </div>
</div>

<!-- ==================== ROOM ==================== -->
<div id="view-room" style="display:none" class="room-view">
  <div class="room-box">
    <h2>ç­‰å¾…ç©å®¶åŠ å…¥</h2>
    <div class="code-card">
      <div class="code-label">æŠŠä»£ç å‘ç»™å¥½å‹</div>
      <div class="code-chars" id="codeChars"></div>
      <button class="code-copy" onclick="copyCode()">ç‚¹å‡»å¤åˆ¶ä»£ç </button>
    </div>
    <div class="plist">
      <h4>ç©å®¶ <span id="plCount">0</span>/6</h4>
      <div id="roomPlayers"></div>
    </div>
    <div class="room-btns">
      <button class="btn-go" id="btnStart" onclick="emitStart()">å¼€å§‹æ¸¸æˆ</button>
      <button class="btn-out" onclick="emitLeave()">ç¦»å¼€</button>
    </div>
    <div class="footer-info" style="margin-top:16px">ä½œè€…ï¼šå­è·¯ Â· å¾®ä¿¡ï¼šREBL_unofficial</div>
  </div>
</div>

<!-- ==================== GAME ==================== -->
<div id="view-game" style="display:none">
  <!-- Top bar -->
  <div class="topbar">
    <span class="title">æ¸…åå¤§å¯Œç¿</span>
    <span class="room-tag" id="gRoomCode">---</span>
    <div class="spacer"></div>
    <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
  </div>
  <div class="dropdown" id="dropMenu" style="display:none">
    <button onclick="showCustom()">âœï¸ è‡ªå®šä¹‰é‡‘é¢</button>
    <button onclick="openOverlay('cards')">ğŸƒ åœ°äº§å¡ / äº‹ä»¶å¡</button>
    <button onclick="openOverlay('rules')">ğŸ“– æ¸¸æˆè§„åˆ™</button>
    <button onclick="printBoard()">ğŸ–¨ï¸ æ‰“å°æ£‹ç›˜</button>
    <button onclick="emitLeave()">ğŸšª ç¦»å¼€æˆ¿é—´</button>
  </div>

  <!-- Board -->
  <div class="board-wrap">
    <div class="board" id="board">
      <div class="board-center" id="boardCenter">
        <div class="bc-bg">
          <div class="gate">ğŸ›ï¸</div>
          <h2>æ¸…åå¤§å¯Œç¿</h2>
          <div class="motto">è‡ªå¼ºä¸æ¯ åšå¾·è½½ç‰©</div>
          <div style="font-size:clamp(5px,1.5vw,9px);color:#aaa;margin-top:clamp(2px,1vw,6px);line-height:1.4">é‡åˆ°bugæ¬¢è¿åŠ å¾®ä¿¡åé¦ˆ<br><b style="color:#888">REBL_unofficial</b></div>
        </div>
        <div class="bc-turn" id="bcTurn"></div>
        <button class="btn-roll" id="bcRollBtn" onclick="emitRoll()">æ·éª°å­ ğŸ²</button>
        <div class="move-info" id="moveInfo" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <!-- Players -->
    <div id="playersArea"></div>

    <!-- Log -->
    <div class="log-box"><h4>æ¸¸æˆè®°å½•</h4><div id="logList"></div></div>

    <!-- Footer -->
    <div class="game-footer">
      ä½œè€…ï¼š<b>å­è·¯</b> Â· å¾®ä¿¡ï¼š<b>REBL_unofficial</b><br>æœ‰åé¦ˆæ¬¢è¿è”ç³»
    </div>
  </div>

  <!-- Chat -->
  <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">ğŸ’¬<span class="badge" id="chatBadge" style="display:none">0</span></button>
  <div class="chat-panel" id="chatPanel" style="display:none">
    <div class="chat-head"><span>èŠå¤©</span><button onclick="toggleChat()">âœ•</button></div>
    <div class="chat-msgs" id="chatMsgs"></div>
    <div class="chat-bar">
      <input id="chatInput" maxlength="200" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeydown="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()">å‘é€</button>
    </div>
  </div>
</div>

<!-- ==================== OVERLAYS ==================== -->
<div class="overlay" id="ov-cards">
  <div class="ov-bar"><h3>å¡ç‰Œ</h3><button onclick="closeOverlay('cards')">âœ•</button></div>
  <div class="ov-body">
    <h3 style="color:var(--purple);margin-bottom:8px">åœ°äº§å¡</h3>
    <div class="deed-grid" id="deedGrid"></div>
    <h3 style="color:var(--purple);margin:16px 0 8px">å­¦ç”Ÿä¼šé€šçŸ¥ï¼ˆæœºä¼šå¡ï¼‰</h3>
    <div class="event-grid" id="chanceGrid"></div>
    <h3 style="color:var(--purple);margin:16px 0 8px">å¥–å­¦é‡‘ï¼ˆå…¬å…±åŸºé‡‘å¡ï¼‰</h3>
    <div class="event-grid" id="chestGrid"></div>
  </div>
</div>
<div class="overlay" id="ov-rules">
  <div class="ov-bar"><h3>æ¸¸æˆè§„åˆ™</h3><button onclick="closeOverlay('rules')">âœ•</button></div>
  <div class="ov-body rules-body">
    <h3>æ¸¸æˆç®€ä»‹</h3><p>æ¸…åå¤§å¯Œç¿æ˜¯ä»¥æ¸…åå¤§å­¦ä¸ºä¸»é¢˜çš„æ¡Œæ¸¸ï¼Œ2~6åç©å®¶åœ¨æ¸…åæ ¡å›­ä¸­è´­ä¹°åœ°äº§ã€æ”¶å–ç§Ÿé‡‘ï¼Œæˆä¸ºæœ€åçš„"æ¸…åé¦–å¯Œ"ï¼</p>
    <h3>æ¸¸æˆå‡†å¤‡</h3><ul><li>æ‰“å°æ£‹ç›˜ï¼ˆå»ºè®®A3å½©è‰²ï¼‰</li><li>å‡†å¤‡éª°å­ä¸¤é¢—ï¼ˆæˆ–ç”¨åœ¨çº¿æ·éª°å­ï¼‰</li><li>å‡†å¤‡æ£‹å­ï¼ˆç¡¬å¸ã€æ©¡çš®ç­‰å‡å¯ï¼‰</li><li>æ¯äººèµ·å§‹èµ„é‡‘ Â¥15,000</li></ul>
    <h3>åŸºæœ¬è§„åˆ™</h3><ul><li><b>æ·éª°å­å‰è¿›</b>ï¼šæ¯å›åˆæ·ä¸¤é¢—éª°å­ï¼ŒæŒ‰ç‚¹æ•°å‰è¿›</li><li><b>ç»è¿‡/åˆ°è¾¾èµ·ç‚¹</b>ï¼šæ”¶å– Â¥2,000</li><li><b>è´­ä¹°åœ°äº§</b>ï¼šåˆ°è¾¾æ— ä¸»åœ°äº§å¯æŒ‰æ ‡ä»·è´­ä¹°</li><li><b>æ”¶å–ç§Ÿé‡‘</b>ï¼šåˆ°è¾¾ä»–äººåœ°äº§éœ€æ”¯ä»˜ç§Ÿé‡‘</li><li><b>å‡çº§åœ°äº§</b>ï¼šé›†é½åŒè‰²åå¯èŠ±é’±å‡çº§ï¼Œç§Ÿé‡‘å¤§å¹…æå‡</li><li><b>æ ¡é—¨</b>ï¼š1ä¸ªÂ¥250 / 2ä¸ªÂ¥500 / 3ä¸ªÂ¥1000 / 4ä¸ªÂ¥2000</li><li><b>æ ¡å›­ç½‘/æ ¡å›­å¡</b>ï¼šéª°å­Ã—4ï¼ˆ1ä¸ªï¼‰æˆ–Ã—10ï¼ˆ2ä¸ªï¼‰</li></ul>
    <h3>ç‰¹æ®Šæ ¼å­</h3><ul><li><b>å­¦ç”Ÿä¼šé€šçŸ¥/å¥–å­¦é‡‘</b>ï¼šæŠ½å¡æ‰§è¡Œ</li><li><b>ç¼´å­¦è´¹</b>ï¼š-Â¥2,000 / <b>äº¤ä¹¦æœ¬è´¹</b>ï¼š-Â¥1,000</li><li><b>æŒ‚ç§‘è¡¥è€ƒï¼ˆç›‘ç‹±ï¼‰</b>ï¼šæ·åŒæ•°æˆ–ä»˜Â¥500å‡ºç‹±</li><li><b>è¢«è¾…å¯¼å‘˜çº¦è°ˆ</b>ï¼šç›´æ¥è¿›ç›‘ç‹±</li><li><b>æƒ…äººå¡</b>ï¼šå®‰å…¨ä¼‘æ¯</li></ul>
    <h3>èƒœåˆ©æ¡ä»¶</h3><p>æœ€åä¸€åæœªç ´äº§çš„ç©å®¶è·èƒœï¼Œæˆ–çº¦å®šæ—¶é—´åèµ„äº§æœ€å¤šè€…è·èƒœã€‚</p>
  </div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modalBg"><div class="modal" id="modalBox"></div></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ===== DATA =====
const S=[
  {id:0,n:'å…¥å­¦æŠ¥åˆ°',t:'go',i:'ğŸ“'},
  {id:1,n:'ç´«è†å›­',t:'property',g:'brown',p:600,bc:500,r:[20,100,300,900,1600,2500],i:'ğŸœ'},
  {id:2,n:'å¥–å­¦é‡‘',t:'chest',i:'ğŸ’°'},
  {id:3,n:'æ¸…èŠ¬å›­',t:'property',g:'brown',p:600,bc:500,r:[40,200,600,1800,3200,4500],i:'ğŸ›'},
  {id:4,n:'ç¼´å­¦è´¹',t:'tax',a:2000,i:'ğŸ’¸'},
  {id:5,n:'ä¸œé—¨',t:'railroad',p:2000,i:'ğŸšª'},
  {id:6,n:'æ¡ƒæå›­',t:'property',g:'lightblue',p:1000,bc:500,r:[60,300,900,2700,4000,5500],i:'ğŸ±'},
  {id:7,n:'å­¦ç”Ÿä¼šé€šçŸ¥',t:'chance',i:'ğŸ“‹'},
  {id:8,n:'å¬æ¶›å›­',t:'property',g:'lightblue',p:1000,bc:500,r:[60,300,900,2700,4000,5500],i:'ğŸ²'},
  {id:9,n:'èŠå…°å›­',t:'property',g:'lightblue',p:1200,bc:500,r:[80,400,1000,3000,4500,6000],i:'ğŸ¥˜'},
  {id:10,n:'æŒ‚ç§‘è¡¥è€ƒ',t:'jail',i:'ğŸ“'},
  {id:11,n:'å…­æ•™',t:'property',g:'pink',p:1400,bc:1000,r:[100,500,1500,4500,6250,7500],i:'ğŸ“š'},
  {id:12,n:'æ ¡å›­ç½‘',t:'utility',p:1500,i:'ğŸ“¶'},
  {id:13,n:'å››æ•™',t:'property',g:'pink',p:1400,bc:1000,r:[100,500,1500,4500,6250,7500],i:'ğŸ«'},
  {id:14,n:'ä¸‰æ•™',t:'property',g:'pink',p:1600,bc:1000,r:[120,600,1800,5000,7000,9000],i:'ğŸ’'},
  {id:15,n:'å—é—¨',t:'railroad',p:2000,i:'ğŸšª'},
  {id:16,n:'è¥¿æ“',t:'property',g:'orange',p:1800,bc:1000,r:[140,700,2000,5500,7500,9500],i:'âš½'},
  {id:17,n:'å¥–å­¦é‡‘',t:'chest',i:'ğŸ’°'},
  {id:18,n:'ä¸œæ“',t:'property',g:'orange',p:1800,bc:1000,r:[140,700,2000,5500,7500,9500],i:'ğŸ€'},
  {id:19,n:'ç»¼åˆä½“è‚²é¦†',t:'property',g:'orange',p:2000,bc:1000,r:[160,800,2200,6000,8000,10000],i:'ğŸŸï¸'},
  {id:20,n:'æƒ…äººå¡',t:'parking',i:'ğŸ’•'},
  {id:21,n:'å›¾ä¹¦é¦†',t:'property',g:'red',p:2200,bc:1500,r:[180,900,2500,7000,8750,10500],i:'ğŸ“–'},
  {id:22,n:'å­¦ç”Ÿä¼šé€šçŸ¥',t:'chance',i:'ğŸ“‹'},
  {id:23,n:'ç¾æœ¯å­¦é™¢',t:'property',g:'red',p:2200,bc:1500,r:[180,900,2500,7000,8750,10500],i:'ğŸ¨'},
  {id:24,n:'FITæ¥¼',t:'property',g:'red',p:2400,bc:1500,r:[200,1000,3000,7500,9250,11000],i:'ğŸ’»'},
  {id:25,n:'è¥¿é—¨',t:'railroad',p:2000,i:'ğŸšª'},
  {id:26,n:'å¤§ç¤¼å ‚',t:'property',g:'yellow',p:2600,bc:1500,r:[220,1100,3300,8000,9750,11500],i:'ğŸ›ï¸'},
  {id:27,n:'æ–°æ¸…åå­¦å ‚',t:'property',g:'yellow',p:2600,bc:1500,r:[220,1100,3300,8000,9750,11500],i:'ğŸ­'},
  {id:28,n:'æ ¡å›­å¡',t:'utility',p:1500,i:'ğŸ’³'},
  {id:29,n:'è’™æ°‘ä¼ŸéŸ³ä¹å…',t:'property',g:'yellow',p:2800,bc:1500,r:[240,1200,3600,8500,10250,12000],i:'ğŸµ'},
  {id:30,n:'è¢«è¾…å¯¼å‘˜çº¦è°ˆ',t:'gotojail',i:'ğŸ˜±'},
  {id:31,n:'ä¸»æ¥¼',t:'property',g:'green',p:3000,bc:2000,r:[260,1300,3900,9000,11000,12750],i:'ğŸ¢'},
  {id:32,n:'å·¥å­—å…',t:'property',g:'green',p:3000,bc:2000,r:[260,1300,3900,9000,11000,12750],i:'ğŸ¯'},
  {id:33,n:'å¥–å­¦é‡‘',t:'chest',i:'ğŸ’°'},
  {id:34,n:'è¿‘æ˜¥å›­',t:'property',g:'green',p:3200,bc:2000,r:[280,1500,4500,10000,12000,14000],i:'ğŸŒ¸'},
  {id:35,n:'åŒ—é—¨',t:'railroad',p:2000,i:'ğŸšª'},
  {id:36,n:'å­¦ç”Ÿä¼šé€šçŸ¥',t:'chance',i:'ğŸ“‹'},
  {id:37,n:'è‹ä¸–æ°‘ä¹¦é™¢',t:'property',g:'darkblue',p:3500,bc:2000,r:[350,1750,5000,11000,13000,15000],i:'ğŸŒ'},
  {id:38,n:'äº¤ä¹¦æœ¬è´¹',t:'tax',a:1000,i:'ğŸ“•'},
  {id:39,n:'äºŒæ ¡é—¨',t:'property',g:'darkblue',p:4000,bc:2000,r:[500,2000,6000,14000,17000,20000],i:'â›©ï¸'},
];
const GC={brown:'#8B4513',lightblue:'#87CEEB',pink:'#DB7093',orange:'#FF8C00',red:'#DC143C',yellow:'#FFD700',green:'#228B22',darkblue:'#191970'};
const GN={brown:'é£Ÿå ‚åŒº(æ£•)',lightblue:'é£Ÿå ‚åŒº(è“)',pink:'æ•™å­¦æ¥¼(ç²‰)',orange:'è¿åŠ¨åœº(æ©™)',red:'å­¦æœ¯æ¥¼(çº¢)',yellow:'æ–‡åŒ–åœºé¦†(é»„)',green:'å†å²åèƒœ(ç»¿)',darkblue:'æ ‡å¿—å»ºç­‘(è“)'};
const CHANCE=[
  'è·å¾—"å›½å®¶å¥–å­¦é‡‘"ï¼æ”¶å– Â¥8,000','åœ¨"æŒ‘æˆ˜æ¯"ä¸­è·å¥–ï¼Œæ”¶å– Â¥3,000','è‡ªè¡Œè½¦è¢«å·äº†ï¼Œæ”¯ä»˜ Â¥500 ä¹°æ–°è½¦',
  'è®ºæ–‡å‘è¡¨åœ¨ Nature ä¸Šï¼æ”¶å– Â¥5,000','è¢«é€‰ä¸ºå­¦ç”Ÿä¼šä¸»å¸­ï¼Œæ¯ä½ç©å®¶å‘ä½ æ”¯ä»˜ Â¥500','é£Ÿå ‚é¥­å¡å……å€¼æ•…éšœï¼Œæ”¯ä»˜ Â¥200',
  'è·å¾—å‡ºå›½äº¤æ¢æœºä¼šï¼Œå‰è¿›åˆ°èµ·ç‚¹æ”¶å– Â¥2,000','å®¿èˆè¿è§„ç”¨ç”µè¢«æŠ“ï¼Œæ”¯ä»˜ Â¥1,000','è·å¾—åˆ›ä¸šå¤§èµ›å¥–é‡‘ï¼Œæ”¶å– Â¥4,000','æœŸæœ«å¤ä¹ å¤ªç´¯è¿›äº†æ ¡åŒ»é™¢ï¼Œæ”¯ä»˜ Â¥800',
];
const CHEST=[
  'è·å¾—"ä¸€äºŒÂ·ä¹"å¥–å­¦é‡‘ï¼Œæ”¶å– Â¥2,000','åŠ©æ•™å·¥èµ„åˆ°è´¦ï¼Œæ”¶å– Â¥1,500','å®éªŒè®¾å¤‡æŸåï¼Œèµ”å¿ Â¥2,000',
  'é“¶è¡Œè½¬è´¦é”™è¯¯ï¼Œå¤šæ”¶åˆ° Â¥1,000','ç”Ÿæ—¥å¿«ä¹ï¼æ¯ä½ç©å®¶å‘ä½ æ”¯ä»˜ Â¥100','æ ¡åŒ»é™¢çœ‹ç—…ï¼Œæ”¯ä»˜ Â¥500',
  'ç§‘ç ”é¡¹ç›®ç»è´¹åˆ°è´¦ï¼Œæ”¶å– Â¥3,000','ç”µè„‘åäº†éœ€è¦ç»´ä¿®ï¼Œæ”¯ä»˜ Â¥800','è·å¾—ä¼ä¸šèµåŠ©ï¼Œæ”¶å– Â¥2,500','å‰å¾€èµ·ç‚¹ï¼Œæ”¶å– Â¥2,000',
];

const EMOJIS=['ğŸ‘§ğŸ»','ğŸ‘¦ğŸ½','ğŸ‘©ğŸ¿','ğŸ§‘ğŸ¼','ğŸ‘¸ğŸ¾','ğŸ¤´ğŸ»'];

// ===== SOCKET =====
const socket = io();
let room = null, myId = null, animating = false, chatOpen = false, unread = 0, menuOpen = false, prevTurn = -1;

socket.on('connect', () => { myId = socket.id; document.getElementById('connStatus').textContent = 'å·²è¿æ¥ âœ“'; });
socket.on('disconnect', () => { document.getElementById('connStatus').textContent = 'è¿æ¥æ–­å¼€ï¼Œé‡è¿ä¸­...'; });
socket.on('error-msg', m => alert(m));
socket.on('room-update', d => { room = d; refresh(); });
socket.on('dice-rolled', ({ dice, playerIndex, from, to }) => diceAnim(dice, playerIndex, from, to));
socket.on('chat-msg', ({ from, text, color }) => {
  addBubble(from, text, color);
  if (!chatOpen) { unread++; const b=document.getElementById('chatBadge'); b.textContent=unread; b.style.display=''; }
});

// ===== VIEWS =====
function refresh() {
  if (!room) { show('lobby'); return; }
  if (!room.started) { show('room'); renderRoom(); return; }
  show('game'); renderGame();
}
function show(v) {
  ['lobby','room','game'].forEach(n => document.getElementById('view-'+n).style.display = n===v ? '' : 'none');
  if (v==='game') document.getElementById('chatToggle').style.display = 'flex';
}

// ===== LOBBY =====
function createRoom() {
  const n = document.getElementById('inp-cname').value.trim(); if(!n) return;
  socket.emit('create-room', { name: n });
}
function joinRoom() {
  const c = document.getElementById('inp-jcode').value.trim();
  const n = document.getElementById('inp-jname').value.trim();
  if(!c||!n) return;
  socket.emit('join-room', { code: c, name: n });
}
document.getElementById('inp-cname').onkeydown = e => { if(e.key==='Enter') createRoom(); };
document.getElementById('inp-jcode').onkeydown = e => { if(e.key==='Enter') document.getElementById('inp-jname').focus(); };
document.getElementById('inp-jname').onkeydown = e => { if(e.key==='Enter') joinRoom(); };

// ===== ROOM =====
function renderRoom() {
  document.getElementById('codeChars').innerHTML = room.code.split('').map(c=>`<div class="code-char">${c}</div>`).join('');
  document.getElementById('plCount').textContent = room.players.length;
  const list = document.getElementById('roomPlayers');
  list.innerHTML = room.players.map(p=>`<div class="pl-item"><div class="pl-dot" style="background:${p.color}"></div><span class="pl-name">${p.name}</span>${p.id===room.hostId?'<span class="pl-badge">æˆ¿ä¸»</span>':''}</div>`).join('');
  if (room.players.length < 6) list.innerHTML += '<div class="pl-wait">ç­‰å¾…æ›´å¤šç©å®¶åŠ å…¥...</div>';
  document.getElementById('btnStart').style.display = myId===room.hostId ? '' : 'none';
}
function copyCode() {
  navigator.clipboard.writeText(room.code).then(()=>{
    const b=document.querySelector('.code-copy'); b.textContent='å·²å¤åˆ¶!'; setTimeout(()=>b.textContent='ç‚¹å‡»å¤åˆ¶ä»£ç ',1200);
  });
}
function emitStart() { socket.emit('start-game'); }
function emitLeave() { socket.emit('leave-room'); room=null; closeMenu(); show('lobby'); }

// ===== GAME =====
function renderGame() {
  document.getElementById('gRoomCode').textContent = room.code;
  const cp = room.players[room.currentTurn]; if(!cp) return;
  const mi = room.players.findIndex(p => p.id === myId);
  if(room.currentTurn !== prevTurn){ prevTurn = room.currentTurn; lastBuyPromptPos = -1; }
  const emoji = EMOJIS[room.currentTurn % EMOJIS.length];
  document.getElementById('bcTurn').textContent = `${emoji} ${cp.name} çš„å›åˆ Â· ç¬¬${room.round}å›åˆ`;
  const rollBtn = document.getElementById('bcRollBtn');
  rollBtn.disabled = animating || mi !== room.currentTurn;
  rollBtn.style.display = animating ? 'none' : '';

  // Players
  const area = document.getElementById('playersArea');
  area.innerHTML = '';
  room.players.forEach((p, i) => {
    if (p.disconnected) return;
    const isMe = i===mi, isTurn = i===room.currentTurn;
    const emoji = EMOJIS[i % EMOJIS.length];
    const owned = Object.entries(room.properties).filter(([_,v])=>v.owner===i).map(([sid])=>S[+sid]);
    const dots = owned.map(sp=>{const c=sp.g?GC[sp.g]:'#888';return `<div class="pc-dot" style="background:${c}" title="${sp.n}"></div>`;}).join('');
    const posN = S[p.position]?.n || 'èµ·ç‚¹';
    const card = document.createElement('div');
    card.className = `player-card${isMe?' is-me':''}${isTurn?' on-turn':''}`;
    card.style.borderLeftColor = p.color;
    card.innerHTML = `
      <div class="pc-top"><span class="pc-name" style="color:${p.color}"><span class="pc-emoji">${emoji}</span>${p.name}${isMe?' (æˆ‘)':''}</span><span class="pc-money${p.money<0?' negative':''}">${p.money<0?'-':''}Â¥${Math.abs(p.money).toLocaleString()}</span></div>
      <div class="pc-pos">ğŸ“ ${posN}${p.bankrupt?' Â· å·²ç ´äº§':''}</div>
      <div class="pc-props">${dots||'<span style="font-size:10px;color:#ccc">æš‚æ— åœ°äº§</span>'}</div>`;
    area.appendChild(card);
  });

  // Tokens on board (skip during step animation)
  if(!animating) updateTokens();

  // Log
  document.getElementById('logList').innerHTML = room.log.slice(-20).reverse().map(l=>`<div class="log-entry">${l}</div>`).join('');
}

function updateTokens(){
  document.querySelectorAll('.cell .tokens').forEach(t=>t.innerHTML='');
  if(!room) return;
  room.players.forEach((p,i)=>{
    if(p.disconnected||p.bankrupt) return;
    const cell=document.querySelector(`.cell[data-space="${p.position}"] .tokens`);
    if(!cell) return;
    const tk=document.createElement('span');
    tk.className='tk';
    tk.textContent=EMOJIS[i % EMOJIS.length];
    cell.appendChild(tk);
  });
}

// ===== DICE =====
function diceAnim(dice, pi, from, to) {
  animating=true;
  const bc=document.getElementById('boardCenter');
  const rollBtn=document.getElementById('bcRollBtn');
  rollBtn.style.display='none';
  const [d1,d2]=dice, df=['','âš€','âš','âš‚','âšƒ','âš„','âš…'];
  // Show dice popup in board center
  const popup=document.createElement('div');
  popup.className='dice-popup';
  popup.innerHTML=`<div class="dp-dice"><div class="dp-die rolling" id="dpd1">?</div><div class="dp-die rolling" id="dpd2">?</div></div><div class="dp-total" id="dpTotal"></div><div class="dp-double" id="dpDbl"></div>`;
  bc.appendChild(popup);
  const pd1=document.getElementById('dpd1'),pd2=document.getElementById('dpd2');
  let c=0;
  const iv=setInterval(()=>{
    pd1.textContent=df[Math.floor(Math.random()*6)+1];
    pd2.textContent=df[Math.floor(Math.random()*6)+1];
    if(++c>12){
      clearInterval(iv);
      pd1.textContent=df[d1]; pd2.textContent=df[d2];
      pd1.classList.remove('rolling'); pd2.classList.remove('rolling');
      document.getElementById('dpTotal').textContent=`${d1} + ${d2} = ${d1+d2}`;
      if(d1===d2) document.getElementById('dpDbl').textContent='åŒæ•°ï¼';
      // After showing dice, start movement
      setTimeout(()=>{
        popup.remove();
        if(pi!==undefined && from!==undefined && to!==undefined){
          stepMove(pi, from, to, ()=>{
            animating=false; updateTokens(); boardZoomOut();
            const isMyTurn = room.players[room.currentTurn]?.id === myId;
            if(isMyTurn){ if(!checkAutoBuy()) autoEndTurn(); }
          });
        } else {
          animating=false; updateTokens();
          const isMyTurn = room.players[room.currentTurn]?.id === myId;
          if(isMyTurn) autoEndTurn();
        }
      }, 1000);
    }
  },70);
}

function boardZoomOut(){
  const board=document.getElementById('board');
  board.style.transition='transform .5s ease, transform-origin .5s ease';
  board.style.transform='';
  board.style.transformOrigin='';
  setTimeout(()=>board.style.transition='',600);
}

function boardZoomTo(spaceId){
  const board=document.getElementById('board');
  const cell=document.querySelector(`.cell[data-space="${spaceId}"]`);
  if(!cell||!board) return;
  const bRect=board.getBoundingClientRect();
  const cRect=cell.getBoundingClientRect();
  // Calculate cell center relative to board (in %)
  const cx=((cRect.left+cRect.width/2)-bRect.left)/bRect.width*100;
  const cy=((cRect.top+cRect.height/2)-bRect.top)/bRect.height*100;
  board.style.transition='transform .25s ease, transform-origin .25s ease';
  board.style.transformOrigin=`${cx}% ${cy}%`;
  board.style.transform='scale(2)';
}

function stepMove(pi, from, to, cb){
  const steps=[];
  let pos=from;
  while(pos!==to){ pos=(pos+1)%40; steps.push(pos); }
  room.players[pi].position = from;
  updateTokens();
  const moveInfo=document.getElementById('moveInfo');
  // Zoom to starting position
  boardZoomTo(from);
  let idx=0;
  function nextStep(){
    document.querySelectorAll('.cell').forEach(c=>c.style.outline='');
    if(idx>=steps.length){
      moveInfo.style.display='none';
      cb();
      return;
    }
    room.players[pi].position = steps[idx];
    updateTokens();
    const sp=S[steps[idx]];
    const cell=document.querySelector(`.cell[data-space="${steps[idx]}"]`);
    if(cell) cell.style.outline='2px solid #e74c3c';
    boardZoomTo(steps[idx]);
    // Show location name in board center
    moveInfo.style.display='';
    const isFinal=idx===steps.length-1;
    moveInfo.innerHTML=`<span class="mi-label">${isFinal?'ğŸ“ ':''}${sp?sp.i+' '+sp.n:'?'}</span>`;
    idx++;
    setTimeout(nextStep, isFinal?600:250);
  }
  setTimeout(nextStep, 400);
}

// ===== EMITS =====
function emitRoll(){ socket.emit('roll-dice'); }
function autoEndTurn(){ setTimeout(()=>{ lastBuyPromptPos=-1; socket.emit('end-turn'); }, 800); }

// ===== MENU =====
function toggleMenu(){ menuOpen=!menuOpen; document.getElementById('dropMenu').style.display=menuOpen?'':'none'; }
function closeMenu(){ menuOpen=false; document.getElementById('dropMenu').style.display='none'; }
document.addEventListener('click',e=>{ if(menuOpen && !e.target.closest('.dropdown') && !e.target.closest('.menu-btn')) closeMenu(); });

// ===== MODALS =====
function showModal(h){ document.getElementById('modalBox').innerHTML=h; document.getElementById('modalBg').classList.add('show'); closeMenu(); }
function hideModal(){ document.getElementById('modalBg').classList.remove('show'); }
document.getElementById('modalBg').onclick=e=>{if(e.target===e.currentTarget)hideModal();};

let lastBuyPromptPos = -1;
function checkAutoBuy(){
  if(!room||!room.started) return false;
  const ci=room.currentTurn;
  const p=room.players[ci];
  if(!p||p.disconnected||p.bankrupt) return false;
  const sp=S[p.position];
  if(!sp||!['property','railroad','utility'].includes(sp.t)) return false;
  if(room.properties[sp.id]) return false;
  if(lastBuyPromptPos===p.position) return false;
  lastBuyPromptPos=p.position;
  const emoji=EMOJIS[ci%EMOJIS.length];
  showModal(`<h3>ğŸ  è´­ä¹°åœ°äº§</h3><p style="margin:8px 0">${emoji} <b>${p.name}</b> åˆ°è¾¾äº† <b>${sp.i} ${sp.n}</b></p><p style="font-size:18px;font-weight:700;color:var(--purple);margin:8px 0">Â¥${sp.p.toLocaleString()}</p><p style="font-size:12px;color:#888">å½“å‰ä½™é¢ï¼šÂ¥${p.money.toLocaleString()}</p><div class="modal-btns"><button class="mc" onclick="skipBuy()">ä¸ä¹°</button><button class="mo" onclick="doBuy(${sp.id},${ci})">è´­ä¹°</button></div>`);
  return true;
}
function doBuy(spaceId,pi){ socket.emit('buy-property',{spaceId:spaceId,playerIndex:pi}); hideModal(); autoEndTurn(); }
function skipBuy(){ hideModal(); autoEndTurn(); }
function showCustom(){
  const pl=room.players.filter(p=>!p.bankrupt&&!p.disconnected).map((_,i)=>`<option value="${i}">${room.players[i].name}</option>`).join('');
  showModal(`<h3>è‡ªå®šä¹‰é‡‘é¢</h3><label>ç©å®¶</label><select id="mCP">${pl}</select><label>é‡‘é¢ï¼ˆæ­£=æ”¶å…¥ï¼Œè´Ÿ=æ”¯å‡ºï¼‰</label><input type="number" id="mCA" placeholder="å¦‚ 500 æˆ– -300" inputmode="numeric"><label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label><input id="mCN" placeholder="åŸå› "><div class="modal-btns"><button class="mc" onclick="hideModal()">å–æ¶ˆ</button><button class="mo" onclick="doCustom()">ç¡®è®¤</button></div>`);
  document.getElementById('mCP').value=room.currentTurn;
}
function doCustom(){
  const pi=+document.getElementById('mCP').value,a=+document.getElementById('mCA').value,n=document.getElementById('mCN').value.trim();
  if(isNaN(a))return; socket.emit('adjust-money',{playerIndex:pi,amount:a,note:n||undefined}); hideModal();
}

// ===== CHAT =====
function toggleChat(){
  chatOpen=!chatOpen;
  document.getElementById('chatPanel').style.display=chatOpen?'flex':'none';
  if(chatOpen){unread=0;document.getElementById('chatBadge').style.display='none';document.getElementById('chatInput').focus();}
}
function sendChat(){const inp=document.getElementById('chatInput'),t=inp.value.trim();if(!t)return;socket.emit('send-chat',{text:t});inp.value='';}
function addBubble(from,text,color){
  const m=document.getElementById('chatMsgs'),d=document.createElement('div');d.className='chat-msg';
  d.innerHTML=`<div class="cm-name" style="color:${color||'#666'}">${from}</div><div class="cm-text">${text.replace(/</g,'&lt;')}</div>`;
  m.appendChild(d);m.scrollTop=m.scrollHeight;
}

// ===== OVERLAYS =====
function openOverlay(name){document.getElementById('ov-'+name).classList.add('show');closeMenu();}
function closeOverlay(name){document.getElementById('ov-'+name).classList.remove('show');}

// ===== PRINT =====
function printBoard(){closeMenu();window.print();}

// ===== BOARD =====
function getPos(id){
  if(id===0)return{c:11,r:11};if(id<=9)return{c:11-id,r:11};if(id===10)return{c:1,r:11};
  if(id<=19)return{c:1,r:11-(id-10)};if(id===20)return{c:1,r:1};
  if(id<=29)return{c:id-19,r:1};if(id===30)return{c:11,r:1};return{c:11,r:id-29};
}
function side(id){if([0,10,20,30].includes(id))return'corner';if(id<10)return'bottom';if(id<20)return'left';if(id<30)return'top';return'right';}

(function renderBoard(){
  const board=document.getElementById('board');
  S.forEach(sp=>{
    const pos=getPos(sp.id),sd=side(sp.id);
    const d=document.createElement('div');
    d.className=`cell ${sd==='corner'?'corner':'side-'+sd} type-${sp.t}`;
    d.style.gridColumn=pos.c;d.style.gridRow=pos.r;
    d.setAttribute('data-space',sp.id);
    if(sd==='corner'){d.innerHTML=`<div class="cell-icon">${sp.i}</div><div class="cell-name">${sp.n}</div><div class="tokens"></div>`;}
    else{
      const clr=sp.g?GC[sp.g]:'';const bar=clr?`background:${clr}`:'background:transparent';
      const price=sp.p?`Â¥${sp.p}`:(sp.a?`-Â¥${sp.a}`:'');
      d.innerHTML=`<div class="color-bar" style="${bar}"></div><div class="cell-body"><div class="cell-icon">${sp.i}</div><div class="cell-name">${sp.n}</div>${price?`<div class="cell-price">${price}</div>`:''}</div><div class="tokens"></div>`;
    }
    board.appendChild(d);
  });
})();

// ===== CARDS =====
(function renderCards(){
  const dg=document.getElementById('deedGrid');
  S.filter(s=>s.t==='property').forEach(sp=>{
    dg.innerHTML+=`<div class="deed-card"><div class="dc-color" style="background:${GC[sp.g]}"></div><div class="dc-name">${sp.i} ${sp.n}</div><div class="dc-sub">${GN[sp.g]}</div><hr>
    <div class="dc-row"><span>è´­ä¹°</span><b>Â¥${sp.p}</b></div><hr>
    <div class="dc-row"><span>åŸºç¡€ç§Ÿé‡‘</span><span>Â¥${sp.r[0]}</span></div><div class="dc-row"><span>åŒè‰²Ã—2</span><span>Â¥${sp.r[0]*2}</span></div>
    ${sp.r.slice(1).map((v,j)=>`<div class="dc-row"><span>å‡çº§${j+1}</span><span>Â¥${v.toLocaleString()}</span></div>`).join('')}<hr>
    <div class="dc-row"><span>å‡çº§è´¹</span><b>Â¥${sp.bc}</b></div><div class="dc-row"><span>æŠµæŠ¼</span><span>Â¥${Math.floor(sp.p/2)}</span></div></div>`;
  });
  S.filter(s=>s.t==='railroad').forEach(sp=>{
    dg.innerHTML+=`<div class="deed-card"><div class="dc-color" style="background:#555"></div><div class="dc-name">${sp.i} ${sp.n}</div><div class="dc-sub">æ ¡é—¨</div><hr>
    <div class="dc-row"><span>è´­ä¹°</span><b>Â¥2,000</b></div><hr>
    <div class="dc-row"><span>1ä¸ª</span><span>Â¥250</span></div><div class="dc-row"><span>2ä¸ª</span><span>Â¥500</span></div>
    <div class="dc-row"><span>3ä¸ª</span><span>Â¥1,000</span></div><div class="dc-row"><span>4ä¸ª</span><span>Â¥2,000</span></div></div>`;
  });
  S.filter(s=>s.t==='utility').forEach(sp=>{
    dg.innerHTML+=`<div class="deed-card"><div class="dc-color" style="background:#888"></div><div class="dc-name">${sp.i} ${sp.n}</div><div class="dc-sub">å…¬ç”¨è®¾æ–½</div><hr>
    <div class="dc-row"><span>è´­ä¹°</span><b>Â¥1,500</b></div><hr>
    <div class="dc-row"><span>1ä¸ª</span><span>éª°å­Ã—4</span></div><div class="dc-row"><span>2ä¸ª</span><span>éª°å­Ã—10</span></div></div>`;
  });
  CHANCE.forEach(t=>{document.getElementById('chanceGrid').innerHTML+=`<div class="event-card chance"><div class="ev-title">ğŸ“‹ å­¦ç”Ÿä¼šé€šçŸ¥</div>${t}</div>`;});
  CHEST.forEach(t=>{document.getElementById('chestGrid').innerHTML+=`<div class="event-card chest"><div class="ev-title">ğŸ’° å¥–å­¦é‡‘</div>${t}</div>`;});
})();
</script>
</body>
</html>
