<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…åå¤§å¯Œç¿ THU Monopoly</title>
  <style>
    /* ===== Reset & Base ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --thu-purple: #660874;
      --thu-light: #f3e8f9;
      --board-size: 722px;
      --corner: 100px;
      --cell: 58px;
    }
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', 'Hiragino Sans GB', sans-serif;
      background: #f5f0eb;
      color: #333;
    }

    /* ===== Navigation ===== */
    .top-bar {
      background: var(--thu-purple);
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 20px;
      height: 56px;
      gap: 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-bar h1 { font-size: 20px; white-space: nowrap; }
    .tabs { display: flex; gap: 4px; }
    .tabs button {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      transition: background .2s;
    }
    .tabs button:hover { background: rgba(255,255,255,0.3); }
    .tabs button.active { background: #fff; color: var(--thu-purple); font-weight: 600; }

    /* ===== Tab Content ===== */
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }

    /* ===== BOARD ===== */
    .board-wrap { display: flex; flex-direction: column; align-items: center; }
    .board-actions { margin-bottom: 12px; }
    .board-actions button {
      background: var(--thu-purple); color: #fff; border: none;
      padding: 8px 20px; border-radius: 6px; cursor: pointer;
      font-size: 14px; font-family: inherit;
    }
    .board {
      display: grid;
      grid-template-columns: var(--corner) repeat(9, var(--cell)) var(--corner);
      grid-template-rows: var(--corner) repeat(9, var(--cell)) var(--corner);
      width: var(--board-size);
      height: var(--board-size);
      border: 3px solid #333;
      background: #cde6d0;
      position: relative;
    }

    /* Board center */
    .board-center {
      grid-column: 2 / 11;
      grid-row: 2 / 11;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #cde6d0;
      text-align: center;
      padding: 20px;
      position: relative;
    }
    .board-center h2 {
      font-size: 36px;
      color: var(--thu-purple);
      margin-bottom: 8px;
      letter-spacing: 6px;
    }
    .board-center .motto {
      font-size: 16px;
      color: #555;
      letter-spacing: 4px;
      margin-bottom: 16px;
    }
    .board-center .gate {
      font-size: 64px;
      margin-bottom: 12px;
    }
    .board-center .subtitle {
      font-size: 11px;
      color: #888;
      line-height: 1.6;
    }

    /* Cell base */
    .cell {
      border: 1px solid #555;
      position: relative;
      overflow: hidden;
      background: #e8f5e9;
      display: flex;
      flex-direction: column;
    }

    /* Color bar for properties */
    .cell .color-bar {
      flex-shrink: 0;
    }
    /* Bottom row: color bar on top */
    .cell.side-bottom .color-bar { height: 14px; width: 100%; }
    .cell.side-bottom .cell-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }

    /* Top row: color bar on bottom */
    .cell.side-top { flex-direction: column-reverse; }
    .cell.side-top .color-bar { height: 14px; width: 100%; }
    .cell.side-top .cell-body {
      flex: 1; display: flex; flex-direction: column-reverse;
      align-items: center; justify-content: center;
    }

    /* Left column: color bar on right */
    .cell.side-left { flex-direction: row-reverse; }
    .cell.side-left .color-bar { width: 14px; height: 100%; }
    .cell.side-left .cell-body {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    /* Right column: color bar on left */
    .cell.side-right { flex-direction: row; }
    .cell.side-right .color-bar { width: 14px; height: 100%; }
    .cell.side-right .cell-body {
      flex: 1; display: flex; flex-direction: column-reverse;
      align-items: center; justify-content: center;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    /* Cell text */
    .cell .cell-icon { font-size: 14px; line-height: 1; }
    .cell .cell-name { font-size: 9px; font-weight: 600; line-height: 1.2; text-align: center; }
    .cell .cell-price { font-size: 8px; color: #555; }

    /* Corner cells */
    .cell.corner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #d4edda;
      font-size: 10px;
      font-weight: 700;
      text-align: center;
    }
    .cell.corner .cell-icon { font-size: 22px; margin-bottom: 2px; }
    .cell.corner .cell-name { font-size: 9px; }

    /* Special cell backgrounds */
    .cell.type-go { background: #d4edda; }
    .cell.type-jail { background: #f0e0d0; }
    .cell.type-parking { background: #ffe0e8; }
    .cell.type-gotojail { background: #ffd0d0; }
    .cell.type-tax { background: #f5f5dc; }
    .cell.type-chance { background: #fff3cd; }
    .cell.type-chest { background: #d1ecf1; }
    .cell.type-railroad { background: #e2e3e5; }
    .cell.type-utility { background: #e2e3e5; }

    /* ===== COMPANION ===== */
    .companion { max-width: 600px; margin: 0 auto; }

    /* Setup phase */
    .setup-card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .setup-card h3 { color: var(--thu-purple); margin-bottom: 16px; }
    .player-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .player-row input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    .player-row input:focus { border-color: var(--thu-purple); outline: none; }
    .color-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 0 2px #ccc;
      cursor: pointer;
      flex-shrink: 0;
    }
    .color-dot.selected { box-shadow: 0 0 0 3px var(--thu-purple); }
    .player-count-btns { display: flex; gap: 8px; margin-bottom: 16px; }
    .player-count-btns button {
      width: 40px; height: 40px;
      border-radius: 8px;
      border: 2px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
    }
    .player-count-btns button.active { border-color: var(--thu-purple); background: var(--thu-light); color: var(--thu-purple); }
    .btn-primary {
      background: var(--thu-purple);
      color: #fff;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      font-family: inherit;
      font-weight: 600;
    }
    .btn-primary:hover { opacity: 0.9; }

    /* Game phase */
    .game-header {
      background: var(--thu-purple);
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .game-header .turn-info { font-size: 18px; font-weight: 600; }
    .game-header .round-info { font-size: 13px; opacity: 0.8; }

    .dice-section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .dice-display { display: flex; justify-content: center; gap: 16px; margin: 16px 0; }
    .die {
      width: 56px;
      height: 56px;
      background: #fff;
      border: 3px solid #333;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      transition: transform 0.3s;
    }
    .die.rolling { animation: diceRoll 0.3s ease-in-out; }
    @keyframes diceRoll {
      0%, 100% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(15deg) scale(1.1); }
      75% { transform: rotate(-15deg) scale(1.1); }
    }
    .dice-result { font-size: 14px; color: #666; margin-bottom: 12px; }
    .btn-roll {
      background: #e74c3c;
      color: #fff;
      border: none;
      padding: 12px 40px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      font-family: inherit;
    }
    .btn-roll:hover { background: #c0392b; }
    .btn-roll:disabled { background: #ccc; cursor: not-allowed; }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .player-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border-left: 5px solid #ccc;
      transition: all .2s;
    }
    .player-card.active-player { box-shadow: 0 4px 20px rgba(102,8,116,0.2); }
    .player-card .p-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .player-card .p-name { font-weight: 700; font-size: 16px; }
    .player-card .p-money { font-size: 20px; font-weight: 700; color: #27ae60; }
    .player-card .p-pos { font-size: 12px; color: #888; margin-bottom: 8px; }
    .player-card .p-props { display: flex; flex-wrap: wrap; gap: 4px; }
    .player-card .p-prop-dot {
      width: 18px; height: 12px;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.2);
      font-size: 7px;
      display: flex; align-items: center; justify-content: center;
      color: #fff;
    }
    .player-card .money-btns { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .player-card .money-btns button {
      padding: 4px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f8f8f8;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
    }
    .player-card .money-btns button:hover { background: #eee; }
    .player-card .money-btns button.pay { color: #e74c3c; }
    .player-card .money-btns button.earn { color: #27ae60; }

    .action-bar {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .action-bar h4 { margin-bottom: 10px; color: var(--thu-purple); }
    .action-btns { display: flex; flex-wrap: wrap; gap: 8px; }
    .action-btns button {
      padding: 8px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-family: inherit;
    }
    .action-btns button:hover { border-color: var(--thu-purple); background: var(--thu-light); }

    .game-log {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      max-height: 200px;
      overflow-y: auto;
    }
    .game-log h4 { margin-bottom: 8px; color: var(--thu-purple); }
    .game-log .log-entry { font-size: 12px; padding: 4px 0; border-bottom: 1px solid #f0f0f0; color: #555; }
    .game-log .log-entry:last-child { border-bottom: none; }

    /* Transfer modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
    }
    .modal h3 { color: var(--thu-purple); margin-bottom: 16px; }
    .modal label { display: block; font-size: 13px; color: #666; margin-bottom: 4px; margin-top: 12px; }
    .modal select, .modal input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    .modal-btns { display: flex; gap: 8px; margin-top: 20px; }
    .modal-btns button {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
      border: none;
    }
    .modal-btns .btn-cancel { background: #eee; color: #333; }
    .modal-btns .btn-confirm { background: var(--thu-purple); color: #fff; }

    /* ===== CARDS ===== */
    .cards-section { max-width: 900px; margin: 0 auto; }
    .cards-section h3 { color: var(--thu-purple); margin: 20px 0 12px; }
    .cards-section .print-btn { margin-bottom: 16px; }
    .cards-section .print-btn button {
      background: var(--thu-purple); color: #fff; border: none;
      padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-family: inherit;
    }
    .deed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .deed-card {
      border: 2px solid #333;
      border-radius: 8px;
      padding: 12px;
      background: #fff;
      font-size: 11px;
    }
    .deed-card .deed-color {
      height: 24px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .deed-card .deed-name {
      text-align: center;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .deed-card hr { border: none; border-top: 1px solid #ccc; margin: 6px 0; }
    .deed-card .deed-row { display: flex; justify-content: space-between; padding: 2px 0; }

    .event-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }
    .event-card {
      border: 2px solid #333;
      border-radius: 8px;
      padding: 14px;
      text-align: center;
      font-size: 12px;
      line-height: 1.5;
    }
    .event-card.chance { background: #fff9e6; border-color: #f0ad4e; }
    .event-card.chest { background: #e8f4fd; border-color: #5bc0de; }
    .event-card .event-title { font-weight: 700; font-size: 13px; margin-bottom: 8px; }

    /* ===== RULES ===== */
    .rules-section { max-width: 700px; margin: 0 auto; line-height: 1.8; }
    .rules-section h3 { color: var(--thu-purple); margin: 20px 0 8px; border-bottom: 2px solid var(--thu-purple); padding-bottom: 4px; }
    .rules-section p, .rules-section li { font-size: 14px; }
    .rules-section ul { padding-left: 20px; margin-bottom: 12px; }

    /* ===== PRINT ===== */
    @media print {
      .top-bar, .board-actions, .no-print { display: none !important; }
      body { background: #fff; }
      .tab-content { display: none !important; padding: 0; }
      .tab-content.print-target { display: block !important; }
      .board {
        width: 260mm;
        height: 260mm;
        --corner: 30.4mm;
        --cell: 22.1mm;
        grid-template-columns: var(--corner) repeat(9, var(--cell)) var(--corner);
        grid-template-rows: var(--corner) repeat(9, var(--cell)) var(--corner);
        border-width: 2px;
      }
      .cell .cell-name { font-size: 8pt; }
      .cell .cell-price { font-size: 7pt; }
      .cell .cell-icon { font-size: 12pt; }
      .cell.corner .cell-icon { font-size: 18pt; }
      .board-center h2 { font-size: 32pt; }
      @page { size: A3 landscape; margin: 10mm; }
    }
  </style>
</head>
<body>

<!-- Top Navigation -->
<div class="top-bar no-print">
  <h1>æ¸…åå¤§å¯Œç¿</h1>
  <div class="tabs">
    <button class="active" onclick="switchTab('board')">æ£‹ç›˜</button>
    <button onclick="switchTab('companion')">æ¸¸æˆåŠ©æ‰‹</button>
    <button onclick="switchTab('cards')">å¡ç‰Œ</button>
    <button onclick="switchTab('rules')">è§„åˆ™</button>
  </div>
</div>

<!-- Board Tab -->
<div id="tab-board" class="tab-content active">
  <div class="board-wrap">
    <div class="board-actions">
      <button onclick="printBoard()">æ‰“å°æ£‹ç›˜ (å»ºè®®A3çº¸)</button>
    </div>
    <div id="board" class="board">
      <div class="board-center">
        <div class="gate">ğŸ›ï¸</div>
        <h2>æ¸…åå¤§å¯Œç¿</h2>
        <div class="motto">è‡ªå¼ºä¸æ¯ åšå¾·è½½ç‰©</div>
        <div class="subtitle">
          TSINGHUA MONOPOLY<br>
          ç»è¿‡èµ·ç‚¹æ”¶å– Â¥2000<br>
          2~6äºº | å»ºè®®æ¸¸æˆæ—¶é—´60~120åˆ†é’Ÿ
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Companion Tab -->
<div id="tab-companion" class="tab-content">
  <div class="companion">
    <!-- Setup Phase -->
    <div id="setup-phase">
      <div class="setup-card">
        <h3>æ¸¸æˆè®¾ç½®</h3>
        <p style="font-size:13px;color:#666;margin-bottom:16px;">é€‰æ‹©ç©å®¶äººæ•°ï¼Œè¾“å…¥å§“åï¼Œå¼€å§‹æ¸¸æˆï¼</p>
        <label style="font-size:13px;color:#666;margin-bottom:8px;display:block;">ç©å®¶äººæ•°</label>
        <div class="player-count-btns" id="countBtns"></div>
        <div id="playerInputs"></div>
        <button class="btn-primary" onclick="startGame()" style="margin-top:16px;">å¼€å§‹æ¸¸æˆ</button>
      </div>
    </div>
    <!-- Game Phase -->
    <div id="game-phase" style="display:none">
      <div class="game-header">
        <div>
          <div class="turn-info" id="turnInfo">--</div>
          <div class="round-info" id="roundInfo">ç¬¬ 1 å›åˆ</div>
        </div>
        <button style="background:rgba(255,255,255,0.2);color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-family:inherit;" onclick="nextTurn()">ä¸‹ä¸€ä½ â–¶</button>
      </div>

      <div class="dice-section">
        <div class="dice-display">
          <div class="die" id="die1">?</div>
          <div class="die" id="die2">?</div>
        </div>
        <div class="dice-result" id="diceResult">ç‚¹å‡»æŒ‰é’®æ·éª°å­</div>
        <button class="btn-roll" id="btnRoll" onclick="rollDice()">æ·éª°å­</button>
      </div>

      <div class="players-grid" id="playersGrid"></div>

      <div class="action-bar">
        <h4>å¿«æ·æ“ä½œ</h4>
        <div class="action-btns">
          <button onclick="showTransfer()">è½¬è´¦</button>
          <button onclick="quickAction('passgo')">è¿‡èµ·ç‚¹ +Â¥2000</button>
          <button onclick="quickAction('tax2000')">ç¼´å­¦è´¹ -Â¥2000</button>
          <button onclick="quickAction('tax1000')">äº¤ä¹¦æœ¬è´¹ -Â¥1000</button>
          <button onclick="showPropertyBuy()">è´­ä¹°åœ°äº§</button>
          <button onclick="showCustomAmount()">è‡ªå®šä¹‰é‡‘é¢</button>
        </div>
      </div>

      <div class="game-log">
        <h4>æ¸¸æˆè®°å½•</h4>
        <div id="logList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Cards Tab -->
<div id="tab-cards" class="tab-content">
  <div class="cards-section">
    <div class="print-btn"><button onclick="printCards()">æ‰“å°å¡ç‰Œ</button></div>
    <h3>åœ°äº§å¡</h3>
    <div class="deed-grid" id="deedGrid"></div>
    <h3>å­¦ç”Ÿä¼šé€šçŸ¥ï¼ˆæœºä¼šå¡ï¼‰</h3>
    <div class="event-grid" id="chanceGrid"></div>
    <h3>å¥–å­¦é‡‘ï¼ˆå…¬å…±åŸºé‡‘å¡ï¼‰</h3>
    <div class="event-grid" id="chestGrid"></div>
  </div>
</div>

<!-- Rules Tab -->
<div id="tab-rules" class="tab-content">
  <div class="rules-section">
    <h3>æ¸¸æˆç®€ä»‹</h3>
    <p>æ¸…åå¤§å¯Œç¿æ˜¯ä»¥æ¸…åå¤§å­¦ä¸ºä¸»é¢˜çš„æ¡Œæ¸¸ï¼Œ2~6åç©å®¶åœ¨æ¸…åæ ¡å›­ä¸­è´­ä¹°åœ°äº§ã€æ”¶å–ç§Ÿé‡‘ï¼Œæˆä¸ºæœ€åçš„"æ¸…åé¦–å¯Œ"ï¼</p>

    <h3>æ¸¸æˆå‡†å¤‡</h3>
    <ul>
      <li>æ‰“å°æ£‹ç›˜ï¼ˆå»ºè®®A3å½©è‰²æ‰“å°ï¼‰</li>
      <li>å‡†å¤‡éª°å­ä¸¤é¢—ï¼ˆæˆ–ä½¿ç”¨æœ¬ç½‘ç«™çš„æ·éª°å­åŠŸèƒ½ï¼‰</li>
      <li>å‡†å¤‡æ£‹å­ï¼ˆç¡¬å¸ã€æ©¡çš®ç­‰å‡å¯ï¼‰</li>
      <li>ä½¿ç”¨æœ¬ç½‘ç«™"æ¸¸æˆåŠ©æ‰‹"ç®¡ç†é‡‘é’±å’Œåœ°äº§ï¼Œå…å»çº¸å¸çƒ¦æ¼</li>
      <li>æ‰“å°"å¡ç‰Œ"é¡µé¢çš„åœ°äº§å¡å’Œäº‹ä»¶å¡ï¼Œå‰ªä¸‹æ¥å¤‡ç”¨</li>
      <li>æ¯äººèµ·å§‹èµ„é‡‘ Â¥15,000</li>
    </ul>

    <h3>åŸºæœ¬è§„åˆ™</h3>
    <ul>
      <li><b>æ·éª°å­å‰è¿›ï¼š</b>æ¯å›åˆæ·ä¸¤é¢—éª°å­ï¼ŒæŒ‰ç‚¹æ•°å‰è¿›</li>
      <li><b>ç»è¿‡/åˆ°è¾¾èµ·ç‚¹ï¼š</b>æ”¶å– Â¥2,000</li>
      <li><b>è´­ä¹°åœ°äº§ï¼š</b>åˆ°è¾¾æ— ä¸»åœ°äº§å¯æŒ‰æ ‡ä»·è´­ä¹°</li>
      <li><b>æ”¶å–ç§Ÿé‡‘ï¼š</b>åˆ°è¾¾ä»–äººåœ°äº§éœ€æ”¯ä»˜ç§Ÿé‡‘ï¼ˆè§åœ°äº§å¡ï¼‰</li>
      <li><b>å‡çº§åœ°äº§ï¼š</b>é›†é½åŒè‰²åœ°äº§åå¯èŠ±é’±å‡çº§ï¼ˆæœ€å¤š3çº§ï¼‰ï¼Œç§Ÿé‡‘å¤§å¹…æå‡</li>
      <li><b>æ ¡é—¨ï¼ˆé“è·¯ï¼‰ï¼š</b>æ‹¥æœ‰è¶Šå¤šæ ¡é—¨ï¼Œç§Ÿé‡‘è¶Šé«˜ï¼ˆ1ä¸ªÂ¥250ï¼Œ2ä¸ªÂ¥500ï¼Œ3ä¸ªÂ¥1000ï¼Œ4ä¸ªÂ¥2000ï¼‰</li>
      <li><b>æ ¡å›­ç½‘/æ ¡å›­å¡ï¼š</b>ç§Ÿé‡‘ä¸ºéª°å­ç‚¹æ•° Ã— 4ï¼ˆæ‹¥æœ‰1ä¸ªï¼‰æˆ– Ã— 10ï¼ˆæ‹¥æœ‰2ä¸ªï¼‰</li>
    </ul>

    <h3>ç‰¹æ®Šæ ¼å­</h3>
    <ul>
      <li><b>å­¦ç”Ÿä¼šé€šçŸ¥ï¼ˆæœºä¼šï¼‰ï¼š</b>æŠ½å–ä¸€å¼ æœºä¼šå¡ï¼ŒæŒ‰æŒ‡ç¤ºæ‰§è¡Œ</li>
      <li><b>å¥–å­¦é‡‘ï¼ˆå…¬å…±åŸºé‡‘ï¼‰ï¼š</b>æŠ½å–ä¸€å¼ å…¬å…±åŸºé‡‘å¡ï¼ŒæŒ‰æŒ‡ç¤ºæ‰§è¡Œ</li>
      <li><b>ç¼´å­¦è´¹ï¼š</b>æ”¯ä»˜ Â¥2,000</li>
      <li><b>äº¤ä¹¦æœ¬è´¹ï¼š</b>æ”¯ä»˜ Â¥1,000</li>
      <li><b>æŒ‚ç§‘è¡¥è€ƒï¼ˆç›‘ç‹±ï¼‰ï¼š</b>è·¯è¿‡ä¸å½±å“ï¼›è¢«å…³è¿›å»éœ€æ·å‡ºåŒæ•°æˆ–æ”¯ä»˜ Â¥500 å‡ºç‹±</li>
      <li><b>è¢«è¾…å¯¼å‘˜çº¦è°ˆï¼š</b>ç›´æ¥è¿›å…¥"æŒ‚ç§‘è¡¥è€ƒ"</li>
      <li><b>æƒ…äººå¡ï¼ˆå…è´¹åœè½¦ï¼‰ï¼š</b>å®‰å…¨ä¼‘æ¯ï¼Œæ— äº‹å‘ç”Ÿ</li>
    </ul>

    <h3>æ¸¸æˆç»“æŸ</h3>
    <p>å½“åªå‰©ä¸€åç©å®¶æœªç ´äº§æ—¶ï¼Œè¯¥ç©å®¶è·èƒœï¼æˆ–çº¦å®šæ—¶é—´ç»“æŸåï¼Œèµ„äº§æœ€å¤šçš„ç©å®¶è·èƒœã€‚</p>
  </div>
</div>

<!-- Transfer Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// ===== GAME DATA =====
const SPACES = [
  { id:0, name:'å…¥å­¦æŠ¥åˆ°', type:'go', icon:'ğŸ“' },
  { id:1, name:'ç´«è†å›­', type:'property', group:'brown', price:600, buildCost:500, rent:[20,100,300,900,1600,2500], icon:'ğŸœ' },
  { id:2, name:'å¥–å­¦é‡‘', type:'chest', icon:'ğŸ’°' },
  { id:3, name:'æ¸…èŠ¬å›­', type:'property', group:'brown', price:600, buildCost:500, rent:[40,200,600,1800,3200,4500], icon:'ğŸ›' },
  { id:4, name:'ç¼´å­¦è´¹', type:'tax', amount:2000, icon:'ğŸ’¸' },
  { id:5, name:'ä¸œé—¨', type:'railroad', price:2000, icon:'ğŸšª' },
  { id:6, name:'æ¡ƒæå›­', type:'property', group:'lightblue', price:1000, buildCost:500, rent:[60,300,900,2700,4000,5500], icon:'ğŸ±' },
  { id:7, name:'å­¦ç”Ÿä¼šé€šçŸ¥', type:'chance', icon:'ğŸ“‹' },
  { id:8, name:'å¬æ¶›å›­', type:'property', group:'lightblue', price:1000, buildCost:500, rent:[60,300,900,2700,4000,5500], icon:'ğŸ²' },
  { id:9, name:'èŠå…°å›­', type:'property', group:'lightblue', price:1200, buildCost:500, rent:[80,400,1000,3000,4500,6000], icon:'ğŸ¥˜' },
  { id:10, name:'æŒ‚ç§‘è¡¥è€ƒ', type:'jail', icon:'ğŸ“' },
  { id:11, name:'å…­æ•™', type:'property', group:'pink', price:1400, buildCost:1000, rent:[100,500,1500,4500,6250,7500], icon:'ğŸ“š' },
  { id:12, name:'æ ¡å›­ç½‘', type:'utility', price:1500, icon:'ğŸ“¶' },
  { id:13, name:'å››æ•™', type:'property', group:'pink', price:1400, buildCost:1000, rent:[100,500,1500,4500,6250,7500], icon:'ğŸ«' },
  { id:14, name:'ä¸‰æ•™', type:'property', group:'pink', price:1600, buildCost:1000, rent:[120,600,1800,5000,7000,9000], icon:'ğŸ’' },
  { id:15, name:'å—é—¨', type:'railroad', price:2000, icon:'ğŸšª' },
  { id:16, name:'è¥¿æ“', type:'property', group:'orange', price:1800, buildCost:1000, rent:[140,700,2000,5500,7500,9500], icon:'âš½' },
  { id:17, name:'å¥–å­¦é‡‘', type:'chest', icon:'ğŸ’°' },
  { id:18, name:'ä¸œæ“', type:'property', group:'orange', price:1800, buildCost:1000, rent:[140,700,2000,5500,7500,9500], icon:'ğŸ€' },
  { id:19, name:'ç»¼åˆä½“è‚²é¦†', type:'property', group:'orange', price:2000, buildCost:1000, rent:[160,800,2200,6000,8000,10000], icon:'ğŸŸï¸' },
  { id:20, name:'æƒ…äººå¡', type:'parking', icon:'ğŸ’•' },
  { id:21, name:'å›¾ä¹¦é¦†', type:'property', group:'red', price:2200, buildCost:1500, rent:[180,900,2500,7000,8750,10500], icon:'ğŸ“–' },
  { id:22, name:'å­¦ç”Ÿä¼šé€šçŸ¥', type:'chance', icon:'ğŸ“‹' },
  { id:23, name:'ç¾æœ¯å­¦é™¢', type:'property', group:'red', price:2200, buildCost:1500, rent:[180,900,2500,7000,8750,10500], icon:'ğŸ¨' },
  { id:24, name:'FITæ¥¼', type:'property', group:'red', price:2400, buildCost:1500, rent:[200,1000,3000,7500,9250,11000], icon:'ğŸ’»' },
  { id:25, name:'è¥¿é—¨', type:'railroad', price:2000, icon:'ğŸšª' },
  { id:26, name:'å¤§ç¤¼å ‚', type:'property', group:'yellow', price:2600, buildCost:1500, rent:[220,1100,3300,8000,9750,11500], icon:'ğŸ›ï¸' },
  { id:27, name:'æ–°æ¸…åå­¦å ‚', type:'property', group:'yellow', price:2600, buildCost:1500, rent:[220,1100,3300,8000,9750,11500], icon:'ğŸ­' },
  { id:28, name:'æ ¡å›­å¡', type:'utility', price:1500, icon:'ğŸ’³' },
  { id:29, name:'è’™æ°‘ä¼ŸéŸ³ä¹å…', type:'property', group:'yellow', price:2800, buildCost:1500, rent:[240,1200,3600,8500,10250,12000], icon:'ğŸµ' },
  { id:30, name:'è¢«è¾…å¯¼å‘˜çº¦è°ˆ', type:'gotojail', icon:'ğŸ˜±' },
  { id:31, name:'ä¸»æ¥¼', type:'property', group:'green', price:3000, buildCost:2000, rent:[260,1300,3900,9000,11000,12750], icon:'ğŸ¢' },
  { id:32, name:'å·¥å­—å…', type:'property', group:'green', price:3000, buildCost:2000, rent:[260,1300,3900,9000,11000,12750], icon:'ğŸ¯' },
  { id:33, name:'å¥–å­¦é‡‘', type:'chest', icon:'ğŸ’°' },
  { id:34, name:'è¿‘æ˜¥å›­', type:'property', group:'green', price:3200, buildCost:2000, rent:[280,1500,4500,10000,12000,14000], icon:'ğŸŒ¸' },
  { id:35, name:'åŒ—é—¨', type:'railroad', price:2000, icon:'ğŸšª' },
  { id:36, name:'å­¦ç”Ÿä¼šé€šçŸ¥', type:'chance', icon:'ğŸ“‹' },
  { id:37, name:'è‹ä¸–æ°‘ä¹¦é™¢', type:'property', group:'darkblue', price:3500, buildCost:2000, rent:[350,1750,5000,11000,13000,15000], icon:'ğŸŒ' },
  { id:38, name:'äº¤ä¹¦æœ¬è´¹', type:'tax', amount:1000, icon:'ğŸ“•' },
  { id:39, name:'äºŒæ ¡é—¨', type:'property', group:'darkblue', price:4000, buildCost:2000, rent:[500,2000,6000,14000,17000,20000], icon:'â›©ï¸' },
];

const GROUP_COLORS = {
  brown:'#8B4513', lightblue:'#87CEEB', pink:'#DB7093', orange:'#FF8C00',
  red:'#DC143C', yellow:'#FFD700', green:'#228B22', darkblue:'#191970'
};

const GROUP_NAMES = {
  brown:'é£Ÿå ‚åŒº(æ£•)', lightblue:'é£Ÿå ‚åŒº(è“)', pink:'æ•™å­¦æ¥¼(ç²‰)', orange:'è¿åŠ¨åœº(æ©™)',
  red:'å­¦æœ¯æ¥¼(çº¢)', yellow:'æ–‡åŒ–åœºé¦†(é»„)', green:'å†å²åèƒœ(ç»¿)', darkblue:'æ ‡å¿—å»ºç­‘(è“)'
};

const PLAYER_COLORS = ['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c'];

const CHANCE_CARDS = [
  { text:'è·å¾—"å›½å®¶å¥–å­¦é‡‘"ï¼æ”¶å– Â¥8,000', action:'gain', amount:8000 },
  { text:'åœ¨"æŒ‘æˆ˜æ¯"ä¸­è·å¥–ï¼Œæ”¶å– Â¥3,000', action:'gain', amount:3000 },
  { text:'è‡ªè¡Œè½¦è¢«å·äº†ï¼Œæ”¯ä»˜ Â¥500 ä¹°æ–°è½¦', action:'pay', amount:500 },
  { text:'è®ºæ–‡å‘è¡¨åœ¨ Nature ä¸Šï¼æ”¶å– Â¥5,000', action:'gain', amount:5000 },
  { text:'è¢«é€‰ä¸ºå­¦ç”Ÿä¼šä¸»å¸­ï¼Œæ¯ä½ç©å®¶å‘ä½ æ”¯ä»˜ Â¥500', action:'collect', amount:500 },
  { text:'é£Ÿå ‚é¥­å¡å……å€¼æ•…éšœï¼Œæ”¯ä»˜ Â¥200', action:'pay', amount:200 },
  { text:'è·å¾—å‡ºå›½äº¤æ¢æœºä¼šï¼Œå‰è¿›åˆ°èµ·ç‚¹æ”¶å– Â¥2,000', action:'goto', dest:0 },
  { text:'å®¿èˆè¿è§„ç”¨ç”µè¢«æŠ“ï¼Œæ”¯ä»˜ Â¥1,000', action:'pay', amount:1000 },
  { text:'è·å¾—åˆ›ä¸šå¤§èµ›å¥–é‡‘ï¼Œæ”¶å– Â¥4,000', action:'gain', amount:4000 },
  { text:'æœŸæœ«å¤ä¹ å¤ªç´¯è¿›äº†æ ¡åŒ»é™¢ï¼Œæ”¯ä»˜ Â¥800', action:'pay', amount:800 },
];

const CHEST_CARDS = [
  { text:'è·å¾—"ä¸€äºŒÂ·ä¹"å¥–å­¦é‡‘ï¼Œæ”¶å– Â¥2,000', action:'gain', amount:2000 },
  { text:'åŠ©æ•™å·¥èµ„åˆ°è´¦ï¼Œæ”¶å– Â¥1,500', action:'gain', amount:1500 },
  { text:'å®éªŒè®¾å¤‡æŸåï¼Œèµ”å¿ Â¥2,000', action:'pay', amount:2000 },
  { text:'é“¶è¡Œè½¬è´¦é”™è¯¯ï¼Œå¤šæ”¶åˆ° Â¥1,000', action:'gain', amount:1000 },
  { text:'ç”Ÿæ—¥å¿«ä¹ï¼æ¯ä½ç©å®¶å‘ä½ æ”¯ä»˜ Â¥100', action:'collect', amount:100 },
  { text:'æ ¡åŒ»é™¢çœ‹ç—…ï¼Œæ”¯ä»˜ Â¥500', action:'pay', amount:500 },
  { text:'ç§‘ç ”é¡¹ç›®ç»è´¹åˆ°è´¦ï¼Œæ”¶å– Â¥3,000', action:'gain', amount:3000 },
  { text:'ç”µè„‘åäº†éœ€è¦ç»´ä¿®ï¼Œæ”¯ä»˜ Â¥800', action:'pay', amount:800 },
  { text:'è·å¾—ä¼ä¸šèµåŠ©ï¼Œæ”¶å– Â¥2,500', action:'gain', amount:2500 },
  { text:'å‰å¾€èµ·ç‚¹ï¼Œæ”¶å– Â¥2,000', action:'goto', dest:0 },
];

// ===== BOARD RENDERING =====
function getGridPos(id) {
  if (id === 0) return { col: 11, row: 11 };
  if (id <= 9) return { col: 11 - id, row: 11 };
  if (id === 10) return { col: 1, row: 11 };
  if (id <= 19) return { col: 1, row: 11 - (id - 10) };
  if (id === 20) return { col: 1, row: 1 };
  if (id <= 29) return { col: id - 19, row: 1 };
  if (id === 30) return { col: 11, row: 1 };
  return { col: 11, row: id - 29 };
}

function getSide(id) {
  if ([0,10,20,30].includes(id)) return 'corner';
  if (id < 10) return 'bottom';
  if (id < 20) return 'left';
  if (id < 30) return 'top';
  return 'right';
}

function renderBoard() {
  const board = document.getElementById('board');
  SPACES.forEach(sp => {
    const pos = getGridPos(sp.id);
    const side = getSide(sp.id);
    const div = document.createElement('div');
    div.className = `cell ${side === 'corner' ? 'corner' : 'side-' + side} type-${sp.type}`;
    div.style.gridColumn = pos.col;
    div.style.gridRow = pos.row;

    if (side === 'corner') {
      div.innerHTML = `<div class="cell-icon">${sp.icon}</div><div class="cell-name">${sp.name}</div>`;
    } else {
      const color = sp.group ? GROUP_COLORS[sp.group] : '';
      const barStyle = color ? `background:${color}` : 'background:transparent';
      const priceText = sp.price ? `Â¥${sp.price}` : (sp.amount ? `-Â¥${sp.amount}` : '');
      div.innerHTML = `
        <div class="color-bar" style="${barStyle}"></div>
        <div class="cell-body">
          <div class="cell-icon">${sp.icon}</div>
          <div class="cell-name">${sp.name}</div>
          ${priceText ? `<div class="cell-price">${priceText}</div>` : ''}
        </div>`;
    }
    board.appendChild(div);
  });
}

// ===== TAB MANAGEMENT =====
function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(btn => {
    if (btn.textContent === {board:'æ£‹ç›˜',companion:'æ¸¸æˆåŠ©æ‰‹',cards:'å¡ç‰Œ',rules:'è§„åˆ™'}[name]) btn.classList.add('active');
  });
}

function printBoard() {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('print-target'));
  document.getElementById('tab-board').classList.add('print-target');
  window.print();
}
function printCards() {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('print-target'));
  document.getElementById('tab-cards').classList.add('print-target');
  window.print();
}

// ===== GAME STATE =====
let game = {
  started: false,
  players: [],
  currentTurn: 0,
  round: 1,
  properties: {},
  log: [],
  lastDice: [0, 0],
};

// ===== SETUP =====
let setupPlayerCount = 4;

function initSetup() {
  const countBtns = document.getElementById('countBtns');
  for (let i = 2; i <= 6; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = i === setupPlayerCount ? 'active' : '';
    btn.onclick = () => {
      setupPlayerCount = i;
      document.querySelectorAll('.player-count-btns button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderPlayerInputs();
    };
    countBtns.appendChild(btn);
  }
  renderPlayerInputs();
}

function renderPlayerInputs() {
  const container = document.getElementById('playerInputs');
  container.innerHTML = '';
  for (let i = 0; i < setupPlayerCount; i++) {
    const row = document.createElement('div');
    row.className = 'player-row';
    row.innerHTML = `
      <div class="color-dot" style="background:${PLAYER_COLORS[i]}"></div>
      <input type="text" placeholder="ç©å®¶${i + 1}çš„åå­—" value="ç©å®¶${i + 1}" id="pname-${i}">`;
    container.appendChild(row);
  }
}

function startGame() {
  game.players = [];
  for (let i = 0; i < setupPlayerCount; i++) {
    const name = document.getElementById(`pname-${i}`).value.trim() || `ç©å®¶${i + 1}`;
    game.players.push({
      name,
      color: PLAYER_COLORS[i],
      money: 15000,
      position: 0,
      inJail: false,
      bankrupt: false,
    });
  }
  game.started = true;
  game.currentTurn = 0;
  game.round = 1;
  game.properties = {};
  game.log = [];
  game.lastDice = [0, 0];

  document.getElementById('setup-phase').style.display = 'none';
  document.getElementById('game-phase').style.display = 'block';
  addLog('æ¸¸æˆå¼€å§‹ï¼æ¯äºº Â¥15,000');
  updateGameUI();
}

// ===== GAME UI =====
function updateGameUI() {
  const cp = game.players[game.currentTurn];
  document.getElementById('turnInfo').textContent = `${cp.name} çš„å›åˆ`;
  document.getElementById('turnInfo').style.color = '#fff';
  document.getElementById('roundInfo').textContent = `ç¬¬ ${game.round} å›åˆ`;

  // Player cards
  const grid = document.getElementById('playersGrid');
  grid.innerHTML = '';
  game.players.forEach((p, i) => {
    if (p.bankrupt) return;
    const card = document.createElement('div');
    card.className = `player-card ${i === game.currentTurn ? 'active-player' : ''}`;
    card.style.borderLeftColor = p.color;

    // Properties owned
    const ownedProps = Object.entries(game.properties)
      .filter(([_, v]) => v.owner === i)
      .map(([sid]) => SPACES[parseInt(sid)]);

    const propDots = ownedProps.map(sp => {
      const c = sp.group ? GROUP_COLORS[sp.group] : '#888';
      const lvl = game.properties[sp.id]?.level || 0;
      return `<div class="p-prop-dot" style="background:${c}" title="${sp.name} Lv${lvl}">${lvl > 0 ? lvl : ''}</div>`;
    }).join('');

    const posName = SPACES[p.position]?.name || 'èµ·ç‚¹';

    card.innerHTML = `
      <div class="p-header">
        <span class="p-name" style="color:${p.color}">${p.name}</span>
        <span class="p-money">Â¥${p.money.toLocaleString()}</span>
      </div>
      <div class="p-pos">ä½ç½®: ${posName} ${p.inJail ? '(è¡¥è€ƒä¸­)' : ''}</div>
      <div class="p-props">${propDots || '<span style="font-size:11px;color:#aaa">æš‚æ— åœ°äº§</span>'}</div>
      <div class="money-btns">
        <button class="earn" onclick="adjustMoney(${i}, 500)">+500</button>
        <button class="earn" onclick="adjustMoney(${i}, 1000)">+1000</button>
        <button class="earn" onclick="adjustMoney(${i}, 2000)">+2000</button>
        <button class="pay" onclick="adjustMoney(${i}, -500)">-500</button>
        <button class="pay" onclick="adjustMoney(${i}, -1000)">-1000</button>
        <button class="pay" onclick="adjustMoney(${i}, -2000)">-2000</button>
      </div>`;
    grid.appendChild(card);
  });

  // Log
  const logList = document.getElementById('logList');
  logList.innerHTML = game.log.slice(-20).reverse().map(l => `<div class="log-entry">${l}</div>`).join('');
}

function addLog(text) {
  const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
  game.log.push(`[${time}] ${text}`);
}

// ===== DICE =====
function rollDice() {
  const d1 = Math.floor(Math.random() * 6) + 1;
  const d2 = Math.floor(Math.random() * 6) + 1;
  game.lastDice = [d1, d2];

  const die1 = document.getElementById('die1');
  const die2 = document.getElementById('die2');
  die1.classList.add('rolling');
  die2.classList.add('rolling');

  const dieFaces = ['', 'âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];

  // Animation
  let count = 0;
  const interval = setInterval(() => {
    die1.textContent = dieFaces[Math.floor(Math.random() * 6) + 1];
    die2.textContent = dieFaces[Math.floor(Math.random() * 6) + 1];
    count++;
    if (count > 8) {
      clearInterval(interval);
      die1.textContent = dieFaces[d1];
      die2.textContent = dieFaces[d2];
      die1.classList.remove('rolling');
      die2.classList.remove('rolling');

      const total = d1 + d2;
      const doubles = d1 === d2 ? ' (åŒæ•°ï¼)' : '';
      document.getElementById('diceResult').textContent = `${d1} + ${d2} = ${total}${doubles}`;

      const cp = game.players[game.currentTurn];
      cp.position = (cp.position + total) % 40;
      addLog(`${cp.name} æ·å‡º ${total}${doubles}ï¼Œç§»åŠ¨åˆ° ${SPACES[cp.position].name}`);
      updateGameUI();
    }
  }, 80);
}

// ===== ACTIONS =====
function nextTurn() {
  do {
    game.currentTurn = (game.currentTurn + 1) % game.players.length;
    if (game.currentTurn === 0) game.round++;
  } while (game.players[game.currentTurn].bankrupt);
  document.getElementById('diceResult').textContent = 'ç‚¹å‡»æŒ‰é’®æ·éª°å­';
  document.getElementById('die1').textContent = '?';
  document.getElementById('die2').textContent = '?';
  updateGameUI();
}

function adjustMoney(playerIdx, amount) {
  const p = game.players[playerIdx];
  p.money += amount;
  addLog(`${p.name} ${amount > 0 ? 'æ”¶å…¥' : 'æ”¯å‡º'} Â¥${Math.abs(amount).toLocaleString()}`);
  updateGameUI();
}

function quickAction(action) {
  const cp = game.players[game.currentTurn];
  switch (action) {
    case 'passgo':
      cp.money += 2000;
      addLog(`${cp.name} ç»è¿‡èµ·ç‚¹ï¼Œæ”¶å– Â¥2,000`);
      break;
    case 'tax2000':
      cp.money -= 2000;
      addLog(`${cp.name} ç¼´å­¦è´¹ Â¥2,000`);
      break;
    case 'tax1000':
      cp.money -= 1000;
      addLog(`${cp.name} äº¤ä¹¦æœ¬è´¹ Â¥1,000`);
      break;
  }
  updateGameUI();
}

// ===== MODALS =====
function showModal(html) {
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
}
function hideModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}
document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) hideModal();
});

function showTransfer() {
  const opts = game.players.filter(p => !p.bankrupt)
    .map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
  showModal(`
    <h3>è½¬è´¦</h3>
    <label>ä»˜æ¬¾æ–¹</label>
    <select id="tfFrom">${opts}</select>
    <label>æ”¶æ¬¾æ–¹</label>
    <select id="tfTo">${opts}</select>
    <label>é‡‘é¢</label>
    <input type="number" id="tfAmount" placeholder="è¾“å…¥é‡‘é¢" min="1">
    <div class="modal-btns">
      <button class="btn-cancel" onclick="hideModal()">å–æ¶ˆ</button>
      <button class="btn-confirm" onclick="doTransfer()">ç¡®è®¤è½¬è´¦</button>
    </div>
  `);
  document.getElementById('tfFrom').value = game.currentTurn;
}

function doTransfer() {
  const from = parseInt(document.getElementById('tfFrom').value);
  const to = parseInt(document.getElementById('tfTo').value);
  const amount = parseInt(document.getElementById('tfAmount').value);
  if (isNaN(amount) || amount <= 0 || from === to) return;
  game.players[from].money -= amount;
  game.players[to].money += amount;
  addLog(`${game.players[from].name} å‘ ${game.players[to].name} è½¬è´¦ Â¥${amount.toLocaleString()}`);
  hideModal();
  updateGameUI();
}

function showPropertyBuy() {
  const cp = game.players[game.currentTurn];
  const space = SPACES[cp.position];
  if (!space || !['property', 'railroad', 'utility'].includes(space.type)) {
    // Show full list
    const available = SPACES.filter(s =>
      ['property', 'railroad', 'utility'].includes(s.type) && !game.properties[s.id]
    ).map(s => `<option value="${s.id}">${s.name} - Â¥${s.price}</option>`).join('');
    if (!available) { alert('æ²¡æœ‰å¯è´­ä¹°çš„åœ°äº§äº†'); return; }
    showModal(`
      <h3>è´­ä¹°åœ°äº§</h3>
      <label>é€‰æ‹©åœ°äº§</label>
      <select id="buyProp">${available}</select>
      <label>è´­ä¹°è€…</label>
      <select id="buyPlayer">${game.players.filter(p=>!p.bankrupt).map((p,i)=>`<option value="${i}">${p.name}</option>`).join('')}</select>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="hideModal()">å–æ¶ˆ</button>
        <button class="btn-confirm" onclick="doBuyProperty()">è´­ä¹°</button>
      </div>
    `);
    document.getElementById('buyPlayer').value = game.currentTurn;
  } else if (!game.properties[space.id]) {
    // Quick buy current space
    showModal(`
      <h3>è´­ä¹° ${space.name}</h3>
      <p style="margin:12px 0">ä»·æ ¼: <b>Â¥${space.price.toLocaleString()}</b></p>
      <p>ä½ çš„ä½™é¢: Â¥${cp.money.toLocaleString()}</p>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="hideModal()">å–æ¶ˆ</button>
        <button class="btn-confirm" onclick="doBuyProperty(${space.id}, ${game.currentTurn})">è´­ä¹°</button>
      </div>
    `);
  } else {
    alert('è¯¥åœ°äº§å·²è¢«è´­ä¹°');
  }
}

function doBuyProperty(spaceId, playerIdx) {
  if (spaceId === undefined) {
    spaceId = parseInt(document.getElementById('buyProp').value);
    playerIdx = parseInt(document.getElementById('buyPlayer').value);
  }
  const space = SPACES[spaceId];
  const player = game.players[playerIdx];
  if (player.money < space.price) { alert('ä½™é¢ä¸è¶³ï¼'); return; }
  player.money -= space.price;
  game.properties[spaceId] = { owner: playerIdx, level: 0 };
  addLog(`${player.name} è´­ä¹°äº† ${space.name}ï¼ŒèŠ±è´¹ Â¥${space.price.toLocaleString()}`);
  hideModal();
  updateGameUI();
}

function showCustomAmount() {
  const opts = game.players.filter(p => !p.bankrupt)
    .map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
  showModal(`
    <h3>è‡ªå®šä¹‰é‡‘é¢è°ƒæ•´</h3>
    <label>ç©å®¶</label>
    <select id="customPlayer">${opts}</select>
    <label>é‡‘é¢ï¼ˆæ­£æ•°ä¸ºæ”¶å…¥ï¼Œè´Ÿæ•°ä¸ºæ”¯å‡ºï¼‰</label>
    <input type="number" id="customAmount" placeholder="ä¾‹å¦‚: 500 æˆ– -300">
    <label>å¤‡æ³¨</label>
    <input type="text" id="customNote" placeholder="å¯é€‰">
    <div class="modal-btns">
      <button class="btn-cancel" onclick="hideModal()">å–æ¶ˆ</button>
      <button class="btn-confirm" onclick="doCustomAmount()">ç¡®è®¤</button>
    </div>
  `);
  document.getElementById('customPlayer').value = game.currentTurn;
}

function doCustomAmount() {
  const idx = parseInt(document.getElementById('customPlayer').value);
  const amount = parseInt(document.getElementById('customAmount').value);
  const note = document.getElementById('customNote').value.trim();
  if (isNaN(amount)) return;
  game.players[idx].money += amount;
  const desc = note || (amount > 0 ? 'æ”¶å…¥' : 'æ”¯å‡º');
  addLog(`${game.players[idx].name} ${desc} Â¥${Math.abs(amount).toLocaleString()}`);
  hideModal();
  updateGameUI();
}

// ===== CARDS RENDERING =====
function renderCards() {
  // Property deeds
  const deedGrid = document.getElementById('deedGrid');
  SPACES.filter(s => s.type === 'property').forEach(sp => {
    const color = GROUP_COLORS[sp.group];
    const card = document.createElement('div');
    card.className = 'deed-card';
    card.innerHTML = `
      <div class="deed-color" style="background:${color}"></div>
      <div class="deed-name">${sp.icon} ${sp.name}</div>
      <div style="text-align:center;font-size:10px;color:#888;margin-bottom:6px">${GROUP_NAMES[sp.group]}</div>
      <hr>
      <div class="deed-row"><span>è´­ä¹°ä»·æ ¼</span><b>Â¥${sp.price.toLocaleString()}</b></div>
      <hr>
      <div class="deed-row"><span>åŸºç¡€ç§Ÿé‡‘</span><span>Â¥${sp.rent[0]}</span></div>
      <div class="deed-row"><span>é›†é½åŒè‰²(Ã—2)</span><span>Â¥${sp.rent[0] * 2}</span></div>
      <div class="deed-row"><span>å‡çº§ 1 çº§</span><span>Â¥${sp.rent[1].toLocaleString()}</span></div>
      <div class="deed-row"><span>å‡çº§ 2 çº§</span><span>Â¥${sp.rent[2].toLocaleString()}</span></div>
      <div class="deed-row"><span>å‡çº§ 3 çº§</span><span>Â¥${sp.rent[3].toLocaleString()}</span></div>
      <div class="deed-row"><span>å‡çº§ 4 çº§</span><span>Â¥${sp.rent[4].toLocaleString()}</span></div>
      <div class="deed-row"><span>å‡çº§ 5 çº§(æ»¡)</span><span>Â¥${sp.rent[5].toLocaleString()}</span></div>
      <hr>
      <div class="deed-row"><span>æ¯æ¬¡å‡çº§è´¹ç”¨</span><b>Â¥${sp.buildCost.toLocaleString()}</b></div>
      <div class="deed-row"><span>æŠµæŠ¼ä»·å€¼</span><span>Â¥${Math.floor(sp.price / 2).toLocaleString()}</span></div>`;
    deedGrid.appendChild(card);
  });

  // Railroad deeds
  SPACES.filter(s => s.type === 'railroad').forEach(sp => {
    const card = document.createElement('div');
    card.className = 'deed-card';
    card.innerHTML = `
      <div class="deed-color" style="background:#555"></div>
      <div class="deed-name">${sp.icon} ${sp.name}</div>
      <div style="text-align:center;font-size:10px;color:#888;margin-bottom:6px">æ ¡é—¨</div>
      <hr>
      <div class="deed-row"><span>è´­ä¹°ä»·æ ¼</span><b>Â¥${sp.price.toLocaleString()}</b></div>
      <hr>
      <div class="deed-row"><span>æ‹¥æœ‰ 1 ä¸ªæ ¡é—¨</span><span>Â¥250</span></div>
      <div class="deed-row"><span>æ‹¥æœ‰ 2 ä¸ªæ ¡é—¨</span><span>Â¥500</span></div>
      <div class="deed-row"><span>æ‹¥æœ‰ 3 ä¸ªæ ¡é—¨</span><span>Â¥1,000</span></div>
      <div class="deed-row"><span>æ‹¥æœ‰ 4 ä¸ªæ ¡é—¨</span><span>Â¥2,000</span></div>
      <hr>
      <div class="deed-row"><span>æŠµæŠ¼ä»·å€¼</span><span>Â¥1,000</span></div>`;
    deedGrid.appendChild(card);
  });

  // Utility deeds
  SPACES.filter(s => s.type === 'utility').forEach(sp => {
    const card = document.createElement('div');
    card.className = 'deed-card';
    card.innerHTML = `
      <div class="deed-color" style="background:#888"></div>
      <div class="deed-name">${sp.icon} ${sp.name}</div>
      <div style="text-align:center;font-size:10px;color:#888;margin-bottom:6px">å…¬ç”¨è®¾æ–½</div>
      <hr>
      <div class="deed-row"><span>è´­ä¹°ä»·æ ¼</span><b>Â¥${sp.price.toLocaleString()}</b></div>
      <hr>
      <div class="deed-row"><span>æ‹¥æœ‰ 1 ä¸ªè®¾æ–½</span><span>éª°å­Ã—4</span></div>
      <div class="deed-row"><span>æ‹¥æœ‰ 2 ä¸ªè®¾æ–½</span><span>éª°å­Ã—10</span></div>
      <hr>
      <div class="deed-row"><span>æŠµæŠ¼ä»·å€¼</span><span>Â¥750</span></div>`;
    deedGrid.appendChild(card);
  });

  // Chance cards
  const chanceGrid = document.getElementById('chanceGrid');
  CHANCE_CARDS.forEach(c => {
    const card = document.createElement('div');
    card.className = 'event-card chance';
    card.innerHTML = `<div class="event-title">ğŸ“‹ å­¦ç”Ÿä¼šé€šçŸ¥</div><div>${c.text}</div>`;
    chanceGrid.appendChild(card);
  });

  // Chest cards
  const chestGrid = document.getElementById('chestGrid');
  CHEST_CARDS.forEach(c => {
    const card = document.createElement('div');
    card.className = 'event-card chest';
    card.innerHTML = `<div class="event-title">ğŸ’° å¥–å­¦é‡‘</div><div>${c.text}</div>`;
    chestGrid.appendChild(card);
  });
}

// ===== INIT =====
renderBoard();
initSetup();
renderCards();
</script>

</body>
</html>
